

/****** Object:  StoredProcedure [dbo].[spGetListPareto]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListPareto]
GO

/****** Object:  StoredProcedure [dbo].[spGetListChosseNguyenNhanPro]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListChosseNguyenNhanPro]
GO

/****** Object:  StoredProcedure [dbo].[spGetListChosseMayPro]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListChosseMayPro]
GO

/****** Object:  StoredProcedure [dbo].[spGetKeHoach]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetKeHoach]
GO

/****** Object:  StoredProcedure [dbo].[spGetLoaiNguyenNhan]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetLoaiNguyenNhan]
GO

/****** Object:  StoredProcedure [dbo].[spSaveTarget]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spSaveTarget]
GO

/****** Object:  StoredProcedure [dbo].[spGetListTarget]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListTarget]
GO

/****** Object:  StoredProcedure [dbo].[spGetBaoCaoTongHopHieuXuat]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetBaoCaoTongHopHieuXuat]
GO

/****** Object:  StoredProcedure [dbo].[spKiemTraGioHopLeRun]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spKiemTraGioHopLeRun]
GO

/****** Object:  StoredProcedure [dbo].[spGetPlaned]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetPlaned]
GO

/****** Object:  StoredProcedure [dbo].[spGetBaoCaoChiTiet]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetBaoCaoChiTiet]
GO

/****** Object:  StoredProcedure [dbo].[spGetCongNhan]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetCongNhan]
GO

/****** Object:  StoredProcedure [dbo].[spDeleteThoiGianNgungMay]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spDeleteThoiGianNgungMay]
GO

/****** Object:  StoredProcedure [dbo].[spKiemTraNgayTrung]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spKiemTraNgayTrung]
GO

/****** Object:  StoredProcedure [dbo].[spKiemTraGioHopLe]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spKiemTraGioHopLe]
GO

/****** Object:  StoredProcedure [dbo].[spGetCaTuNgayDenNgay]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetCaTuNgayDenNgay]
GO

/****** Object:  StoredProcedure [dbo].[spSaveThoiGianNgungMay]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spSaveThoiGianNgungMay]
GO

/****** Object:  StoredProcedure [dbo].[spNguyenNhanNgungMayByProDetails]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spNguyenNhanNgungMayByProDetails]
GO

/****** Object:  StoredProcedure [dbo].[spSaveDevicesCause]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spSaveDevicesCause]
GO

/****** Object:  StoredProcedure [dbo].[GetDON_VI_TINH_GIO]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[GetDON_VI_TINH_GIO]
GO

/****** Object:  StoredProcedure [dbo].[spGetListMayNguyenNhan]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListMayNguyenNhan]
GO

/****** Object:  StoredProcedure [dbo].[spGetListMay]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListMay]
GO

/****** Object:  StoredProcedure [dbo].[spViewLogData]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spViewLogData]
GO

/****** Object:  StoredProcedure [dbo].[spViewLogCmb]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spViewLogCmb]
GO

/****** Object:  StoredProcedure [dbo].[spDownTimeCause]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spDownTimeCause]
GO

/****** Object:  StoredProcedure [dbo].[spDownTimeType]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spDownTimeType]
GO

/****** Object:  StoredProcedure [dbo].[spGetDownTimeType]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetDownTimeType]
GO

/****** Object:  StoredProcedure [dbo].[spGetcbUOMShortName]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetcbUOMShortName]
GO

/****** Object:  StoredProcedure [dbo].[spGetProDuctionOEE]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetProDuctionOEE]
GO

/****** Object:  StoredProcedure [dbo].[spGetHeThongItem]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetHeThongItem]
GO

/****** Object:  StoredProcedure [dbo].[spChossePro]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spChossePro]
GO

/****** Object:  StoredProcedure [dbo].[spGetListChossePro]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListChossePro]
GO

/****** Object:  StoredProcedure [dbo].[spGetSLProSchedule]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetSLProSchedule]
GO

/****** Object:  StoredProcedure [dbo].[spGetcbHeThongbySchedule]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetcbHeThongbySchedule]
GO

/****** Object:  StoredProcedure [dbo].[spGetItemByPro]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetItemByPro]
GO

/****** Object:  StoredProcedure [dbo].[spGetListPrODetails]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListPrODetails]
GO

/****** Object:  StoredProcedure [dbo].[spGetListProductionOrder]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListProductionOrder]
GO

/****** Object:  StoredProcedure [dbo].[spGetListProSchedule]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListProSchedule]
GO

/****** Object:  StoredProcedure [dbo].[GetDON_VI_TINH_TOC_DO]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[GetDON_VI_TINH_TOC_DO]
GO

/****** Object:  StoredProcedure [dbo].[spGetUOM]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetUOM]
GO

/****** Object:  StoredProcedure [dbo].[spUOM]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spUOM]
GO

/****** Object:  StoredProcedure [dbo].[SP_GET_MENU_OEE]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[SP_GET_MENU_OEE]
GO

/****** Object:  StoredProcedure [dbo].[spGetUOMConversionGroup]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetUOMConversionGroup]
GO

/****** Object:  StoredProcedure [dbo].[spUOMConversionGroup]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spUOMConversionGroup]
GO

/****** Object:  StoredProcedure [dbo].[spGetItemGroup]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetItemGroup]
GO

/****** Object:  StoredProcedure [dbo].[spGetItemMay]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetItemMay]
GO

/****** Object:  StoredProcedure [dbo].[spGetMay]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetMay]
GO

/****** Object:  StoredProcedure [dbo].[spEditItemMay]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spEditItemMay]
GO

/****** Object:  StoredProcedure [dbo].[spGetListChosseMay]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListChosseMay]
GO

/****** Object:  StoredProcedure [dbo].[spItemGroup]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spItemGroup]
GO

/****** Object:  StoredProcedure [dbo].[spGetcbUOM]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetcbUOM]
GO

/****** Object:  StoredProcedure [dbo].[spGetUOMConversionGroupdetailByGroup]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetUOMConversionGroupdetailByGroup]
GO

/****** Object:  StoredProcedure [dbo].[spEditGroupDetails]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spEditGroupDetails]
GO

/****** Object:  StoredProcedure [dbo].[spGetSatusProDuct]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetSatusProDuct]
GO

/****** Object:  StoredProcedure [dbo].[spGetItem]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetItem]
GO

/****** Object:  StoredProcedure [dbo].[spEditProDucOrDer]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spEditProDucOrDer]
GO

/****** Object:  StoredProcedure [dbo].[SP_GET_MENU_OF_PARENT_OEE]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[SP_GET_MENU_OF_PARENT_OEE]
GO

/****** Object:  StoredProcedure [dbo].[spEditNhomUser]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spEditNhomUser]
GO

/****** Object:  StoredProcedure [dbo].[spGetMenuPQOEE]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetMenuPQOEE]
GO

/****** Object:  StoredProcedure [dbo].[getAllUsersOEE]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[getAllUsersOEE]
GO

/****** Object:  StoredProcedure [dbo].[GetCTTBThongSoDenNgay_T]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[GetCTTBThongSoDenNgay_T]
GO

/****** Object:  StoredProcedure [dbo].[spOperator]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spOperator]
GO

/****** Object:  StoredProcedure [dbo].[spGetcbOperator]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetcbOperator]
GO

/****** Object:  StoredProcedure [dbo].[spGetMayItem]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetMayItem]
GO

/****** Object:  StoredProcedure [dbo].[spGetProductOrDer]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetProductOrDer]
GO

/****** Object:  StoredProcedure [dbo].[spSaveProductionRun]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spSaveProductionRun]
GO

/****** Object:  StoredProcedure [dbo].[spGetListProductionRun]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListProductionRun]
GO

/****** Object:  StoredProcedure [dbo].[spGetListProductionRunDetails]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[spGetListProductionRunDetails]
GO

/****** Object:  StoredProcedure [dbo].[GetRequestInfomationbySTTVD]    Script Date: 29/03/2021 10:09:10 ******/
DROP PROCEDURE [dbo].[GetRequestInfomationbySTTVD]
GO

/****** Object:  StoredProcedure [dbo].[GetRequestInfomationbySTTVD]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[GetRequestInfomationbySTTVD]
	@STTVD AS INTEGER = 129,
	@username NVARCHAR(50) ='Admin'
AS
DECLARE @NgayHT DATETIME
SET @NgayHT = GETDATE()
SELECT A.* INTO #MAY_TMP FROM dbo.MGetMayUserNgay(@NgayHT,@USERNAME,'-1',-1,-1,-1,'-1','-1',0)  A
SET FMTONLY OFF
SELECT     A.MS_MAY DeviceID,B.TEN_MAY AS DeviceName,D.TEN_LOAI_YEU_CAU_BT,A.MS_LOAI_YEU_CAU_BT TypeOfMaintenanceRequestID, A.MO_TA_TINH_TRANG [Description], CONVERT(INT,ISNULL(A.MS_NGUYEN_NHAN,-1)) AS CauseID, E.TEN_NGUYEN_NHAN,
			A.YEU_CAU Request, A.NGAY_XAY_RA DateOccurred, A.GIO_XAY_RA HourOccurred, A.MS_UU_TIEN PriorityID,C.TEN_UU_TIEN, A.STT ID, A.STT_VAN_DE UserRequestDetailID, A.MS_MAY AS OldDeviceID, A.STT_VAN_DE AS OldUserRequestDetailID,
			CONVERT(BIT,ISNULL(THUC_HIEN_DSX,0)) AS  IsExecuteApproveRequested
FROM         dbo.YEU_CAU_NSD_CHI_TIET AS A  INNER JOIN #MAY_TMP B ON A.MS_MAY = B.MS_MAY 
INNER JOIN dbo.MUC_UU_TIEN C ON C.MS_UU_TIEN = A.MS_UU_TIEN  
INNER JOIN dbo.LOAI_YEU_CAU_BAO_TRI D ON D.MS_LOAI_YEU_CAU_BT = A.MS_LOAI_YEU_CAU_BT
INNER JOIN dbo.NGUYEN_NHAN_DUNG_MAY E ON E.MS_NGUYEN_NHAN = A.MS_NGUYEN_NHAN
WHERE A.STT_VAN_DE= @STTVD
ORDER BY A.MS_MAY



GO

/****** Object:  StoredProcedure [dbo].[spGetListProductionRunDetails]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[spGetListProductionRunDetails]
    @ProductionRunID BIGINT = 28,
    @USERNAME NVARCHAR(250) = 'admin',
    @NNgu INT = 0
AS
BEGIN
    SELECT A.DetailID,
           PrOID,
           ItemID,
		   B.ItemCode,
           A.MS_HE_THONG,
           A.MS_MAY AS TEN_MAY,
           A.MS_MAY,
           OperatorID,
           StartTime,
           EndTime,
           DATEDIFF(MINUTE, A.StartTime, A.EndTime) AS SumMinute,
           ActualQuantity,
           (
               SELECT UOMID FROM dbo.UOMConversionGroupDetails WHERE ID = B.UOM
           ) AS UOM,
           [dbo].[fnGetConvertQuantity](A.ItemID, A.ActualQuantity) AS ConvertQuantity,
           A.DefectQuantity,
           A.ActualSpeed,
           A.StandardSpeed,
           A.StandardOutput,
           A.WorkingCycle,
           A.NumberPerCycle
    FROM dbo.ProductionRunDetails A
        INNER JOIN dbo.Item B
            ON A.ItemID = B.ID
    WHERE A.ProductionRunID = @ProductionRunID;
END;

GO

/****** Object:  StoredProcedure [dbo].[spGetListProductionRun]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[spGetListProductionRun]
	@TuNgay DATE = '10/19/2020',
	@DenNgay DATE  ='12/25/2020',
	@USERNAME NVARCHAR(250) ='admin',
	@NNgu INT = 0
AS 
BEGIN
SELECT ID,Code,StartTime,EndTime,CaSTT,Note FROM dbo.ProductionRun
WHERE  CONVERT(DATE,StartTime) BETWEEN @TuNgay AND @DenNgay ORDER BY Code DESC
END	


GO

/****** Object:  StoredProcedure [dbo].[spSaveProductionRun]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spSaveProductionRun]
    @iThem BIGINT = -1 ,
    @Code NVARCHAR(12) ='11' ,
    @StartTime DATETIME = '2020-12-18 16:19:32.133',
    @EndTime DATETIME ='2020-12-18 16:19:32.133',
    @CaSTT INT =1,
    @Note NVARCHAR(500)  ='2321',
    @sBT NVARCHAR(100) = 'TMPProDucRunDetailsadmin'
AS
    BEGIN
        CREATE TABLE #PROOD
            (
              [DetailID] [BIGINT] NULL ,
              [PrOID] [BIGINT] NULL ,
              [ItemID] [BIGINT] NULL ,
              [MS_HE_THONG] [INT] NULL ,
              [MS_MAY] [NVARCHAR](30) NULL ,
              [OperatorID] [BIGINT] NULL ,
              [StartTime] [DATETIME] NULL ,
              [EndTime] [DATETIME] NULL ,
              [SumMinute] [INT] NULL ,
              [ActualQuantity] DECIMAL(18, 2) NULL ,
              [UOM] [BIGINT] NULL ,
              [ConvertQuantity] NVARCHAR(50) NULL ,
              [DefectQuantity] DECIMAL(18, 2) NULL ,
              [ActualSpeed] DECIMAL(18, 2) NULL ,
              [StandardSpeed] DECIMAL(18, 2) NULL ,
              [StandardOutput] DECIMAL(18, 2) NULL ,
              [WorkingCycle] [INT] NULL ,
              [NumberPerCycle] DECIMAL(18, 2) NULL
            )
        ON  [PRIMARY]
        DECLARE @sSql NVARCHAR(4000)
        SET @sSql = 'INSERT INTO #PROOD (DetailID, PrOID, ItemID, MS_HE_THONG,
                                        MS_MAY, OperatorID, StartTime, EndTime,
                                        SumMinute, ActualQuantity, UOM,
                                        ConvertQuantity, DefectQuantity,
                                        ActualSpeed, StandardSpeed,
                                        StandardOutput, WorkingCycle,
                                        NumberPerCycle) SELECT DetailID, PrOID, ItemID, MS_HE_THONG,
                                        MS_MAY, OperatorID, StartTime, EndTime,
                                        SumMinute, ActualQuantity, UOM,
                                        ConvertQuantity, DefectQuantity,
                                        ActualSpeed, StandardSpeed,
                                        StandardOutput, WorkingCycle,
                                        NumberPerCycle FROM ' + @sBT 
        EXEC (@sSql)

        IF @iThem = -1
            BEGIN
                INSERT  INTO dbo.ProductionRun ( Code, StartTime, EndTime,
                                                 CaSTT, Note )
                VALUES  ( @Code, @StartTime, -- StartTime - datetime
                          @EndTime, -- @ - datetime
                          @CaSTT, -- CaSTT - int
                          @Note  -- Note - nchar(500)
                          )
                SET @iThem = SCOPE_IDENTITY()
            END
        ELSE
            BEGIN
                UPDATE  dbo.ProductionRun
                SET     StartTime = @StartTime, EndTime = @EndTime,
                        CaSTT = @CaSTT, Note = @Note
                WHERE   ID = @iThem

            END

        SELECT  @iThem
--- thêm những cái chưa có trong bảng tạm
        INSERT  INTO dbo.ProductionRunDetails (ProductionRunID, PrOID, ItemID,
                                                MS_HE_THONG, MS_MAY,
                                                OperatorID, StartTime, EndTime,
                                                ActualQuantity, DefectQuantity,
                                                ActualSpeed, StandardSpeed,
                                                StandardOutput, WorkingCycle,
                                                NumberPerCycle )
                SELECT  @iThem, PrOID, ItemID, MS_HE_THONG, MS_MAY, OperatorID,
                        StartTime, EndTime, ActualQuantity, DefectQuantity,
                        ActualSpeed, StandardSpeed, StandardOutput,
                        WorkingCycle, NumberPerCycle
                FROM    #PROOD A
                WHERE   NOT EXISTS ( SELECT *
                                     FROM   dbo.ProductionRunDetails B
                                     WHERE  A.DetailID = B.DetailID )  

--update những cái nào tồn tại trong bảng tạm
IF @iThem <> -1
BEGIN
        UPDATE  A
        SET     A.PrOID = B.PrOID, A.ItemID = B.ItemID,
                A.MS_HE_THONG = B.MS_HE_THONG, A.MS_MAY = B.MS_MAY,
                A.OperatorID = B.OperatorID, A.StartTime = B.StartTime,
                A.EndTime = B.EndTime, A.ActualQuantity = B.ActualQuantity,
                A.DefectQuantity = B.DefectQuantity,
                A.ActualSpeed = B.ActualSpeed,
                A.StandardSpeed = B.StandardSpeed,
                A.StandardOutput = B.StandardOutput,
                A.WorkingCycle = B.WorkingCycle,
                A.NumberPerCycle = B.NumberPerCycle
        FROM    dbo.ProductionRunDetails A
                INNER JOIN #PROOD B ON A.DetailID = B.DetailID
        WHERE   A.ProductionRunID = @iThem


		-- delete những cái chưa có
		DELETE A
		FROM dbo.ProductionRunDetails A 
		WHERE NOT EXISTS(SELECT * FROM #PROOD B WHERE A.PrOID =B.PrOID AND A.ItemID =B.ItemID AND A.MS_MAY =B.MS_MAY) AND A.ProductionRunID = @iThem
        
		END	
    END







GO

/****** Object:  StoredProcedure [dbo].[spGetProductOrDer]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetProductOrDer]
AS 
BEGIN
SELECT DISTINCT A.ID,PrOrNumber FROM dbo.ProductionOrder A
INNER JOIN dbo.PrODetails B ON B.PROID = A.ID
ORDER BY A.PrOrNumber
END	



GO

/****** Object:  StoredProcedure [dbo].[spGetMayItem]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetMayItem]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@DayChuyen INT = 11,
	@Item INT =0,
	@PrOID BIGINT =10053,
	@ItemID BIGINT =8
---- @Item = 1 them item
---- @Item = 0 theo ProSchedule
AS 
BEGIN
IF @Item >0
BEGIN
SELECT DISTINCT A.MS_MAY,A.TEN_MAY FROM dbo.MGetMayUserNgay(GETDATE(),@username,-1,@DayChuyen,-1,-1,'-1','-1', @NNgu) A 	INNER JOIN dbo.ItemMay ON ItemMay.MS_MAY = A.MS_MAY WHERE ItemID =@Item ORDER BY A.TEN_MAY 
END

IF @Item = 0
BEGIN
SELECT DISTINCT A.MS_MAY,A.TEN_MAY FROM dbo.MGetMayUserNgay(GETDATE(),@username,-1,@DayChuyen,-1,-1,'-1','-1', @NNgu) A 	
INNER JOIN dbo.ProSchedule B ON B.MS_MAY = A.MS_MAY
INNER JOIN dbo.PrODetails C ON C.DetailsID = B.DetailsID
WHERE (B.PrOID =@PrOID OR @PrOID  = -1) AND (C.ItemID = @ItemID OR @ItemID  = -1)
ORDER BY A.TEN_MAY
END
END	


GO

/****** Object:  StoredProcedure [dbo].[spGetcbOperator]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetcbOperator]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@CoAll BIT=1
AS 
BEGIN
IF @CoAll = 1
BEGIN
SELECT ID, OperatorName FROM dbo.Operator
UNION SELECT -1 AS ID,'< All >'AS Operator
ORDER BY OperatorName
END
ELSE
BEGIN
SELECT ID,OperatorName FROM dbo.Operator
ORDER BY OperatorName
END	
END	


GO

/****** Object:  StoredProcedure [dbo].[spOperator]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE	PROCEDURE [dbo].[spOperator]
	@Loai NVARCHAR(50) = 'grd',
	@ID BIGINT = 3,
	@OperatorName NVARCHAR(250) = '-1',
	@OperatorCode NVARCHAR(50) = '-1',
	@CardID INT ='-1',
	@Note NVARCHAR(500) = '-1'
AS
BEGIN


--Get luoi 
IF UPPER(@Loai) = UPPER('Grd')
BEGIN
   SELECT ID, OperatorName,OperatorCode, CardID,
          Note FROM dbo.Operator ORDER BY OperatorName
END

--Save
IF UPPER(@Loai) = UPPER('Save')
BEGIN
--THEM
	IF @ID = -1
	BEGIN
		INSERT INTO	dbo.Operator(OperatorCode, OperatorName, CardID,
          Note)
		VALUES(@OperatorCode, @OperatorName, @CardID,
          @Note)
		SELECT SCOPE_IDENTITY();
	END
--SUA
	ELSE
	BEGIN
		UPDATE dbo.Operator SET OperatorCode = @OperatorCode,OperatorName = @OperatorName,CardID=@CardID, Note = @Note
		WHERE ID = @ID
		SELECT @ID;
	END
	END
--Delete 
IF UPPER(@Loai) = UPPER('Delete')
BEGIN
	IF EXISTS (SELECT	* FROM dbo.ProductionRunDetails WHERE OperatorID = @ID)
	BEGIN
		SELECT 1 AS TT		
	END
	ELSE
	BEGIN
		DELETE dbo.Operator WHERE ID = @ID
		DBCC CHECKIDENT (ItemGroup,RESEED,0)
		DBCC CHECKIDENT (ItemGroup,RESEED)
		SELECT 0 AS TT		
	END
END	
END


GO

/****** Object:  StoredProcedure [dbo].[GetCTTBThongSoDenNgay_T]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[GetCTTBThongSoDenNgay_T]
    @MS_MAY NVARCHAR(30) = 'MCLT3G' ,
    @MS_LOAI_CV INT = '1' ,
    @DenNgay DATETIME = '02/2/2020'
AS
SELECT * INTO #TS  FROM (
SELECT @MS_MAY MS_BO_PHAN,@MS_MAY TEN_BO_PHAN,NULL MS_BO_PHAN_CHA, CONVERT(NVARCHAR(10),NULL) AS MS_TS_GSTT, @MS_MAY AS MSBP

UNION
SELECT T1.MS_BO_PHAN, T1.MS_BO_PHAN + ' - ' + T1.TEN_BO_PHAN ,T1.MS_BO_PHAN_CHA, NULL AS MS_TS_GSTT,T1.MS_BO_PHAN AS MSBP
FROM            dbo.CAU_TRUC_THIET_BI AS T1 --INNER JOIN dbo.CAU_TRUC_THIET_BI_TS_GSTT T2 ON T2.MS_BO_PHAN = T1.MS_BO_PHAN AND T2.MS_MAY = T1.MS_MAY
WHERE T1.MS_MAY = @MS_MAY

UNION
--SELECT NULL, T2.TEN_TS_GSTT, T1.MS_BO_PHAN , T1.MS_TS_GSTT, T1.MS_BO_PHAN AS MSBP
--FROM CAU_TRUC_THIET_BI_TS_GSTT T1 INNER JOIN dbo.THONG_SO_GSTT T2 ON T2.MS_TS_GSTT = T1.MS_TS_GSTT
-- WHERE T1.MS_MAY = @MS_MAY AND T2.LOAI_TS = 1
-- AND ( ISNULL(MS_LOAI_CV, -99) = @MS_LOAI_CV
--                  OR @MS_LOAI_CV = -1)) T1;


				   SELECT DISTINCT  NULL, T1.TEN_TS_GSTT, T1.MS_BO_PHAN , T1.MS_TS_GSTT, T1.MS_BO_PHAN AS MSBP  FROM [dbo].[MGetHieuChuanKeGSTT]('01/01/2020',@DenNgay,'admin','-1',-1,-1,'-1','-1',@MS_LOAI_CV,0,0) T1 INNER JOIN dbo.THONG_SO_GSTT T2 ON T1.MS_TS_GSTT = T2.MS_TS_GSTT				   
				   WHERE T1.MS_MAY = @MS_MAY AND T2.LOAI_TS = 1
				   ) T1 ;
WITH RET AS (
 SELECT  T1.MS_BO_PHAN_CHA,T1.MS_BO_PHAN
        FROM    (SELECT * FROM  #TS WHERE MS_BO_PHAN IS NULL   ) T1

        UNION ALL
        SELECT  T2.MS_BO_PHAN_CHA,T2.MS_BO_PHAN
        FROM   (SELECT * FROM  #TS WHERE MS_BO_PHAN IS NOT NULL  ) T2 INNER JOIN
                        RET r ON T2.MS_BO_PHAN = r.MS_BO_PHAN_CHA
)
DELETE #TS WHERE MS_BO_PHAN NOT IN(SELECT DISTINCT MS_BO_PHAN FROM RET  WHERE MS_BO_PHAN IS NOT NULL ) 
SELECT * FROM #TS ORDER BY MS_BO_PHAN

GO

/****** Object:  StoredProcedure [dbo].[getAllUsersOEE]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


 CREATE PROCEDURE [dbo].[getAllUsersOEE]
	@NNgu INT =0
 AS 
 BEGIN
 SELECT A.USERNAME ,
        A.FULL_NAME ,
        B.GROUP_NAME,
        A.DESCRIPTION ,
        A.GROUP_ID,
        HO + ' ' + TEN AS HO_TEN ,
        D.TIME_LOGIN
 FROM   dbo.USERS AS A
        INNER JOIN dbo.NHOM AS B ON B.GROUP_ID = A.GROUP_ID
        LEFT JOIN CONG_NHAN C ON C.MS_CONG_NHAN = A.MS_CONG_NHAN
        LEFT JOIN dbo.LOGIN D ON a.USERNAME = D.USER_LOGIN
 ORDER BY D.TIME_LOGIN DESC ,
        B.GROUP_NAME ,
        A.USERNAME 
 END

 

 
GO

/****** Object:  StoredProcedure [dbo].[spGetMenuPQOEE]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetMenuPQOEE]
		@ID_NHOM BIGINT = 1,
		@Them BIT= 1,
		@NNgu INT =0
AS 
BEGIN
SELECT MENU_ID, CASE @NNgu WHEN 0 THEN MENU_TEXT WHEN 1 THEN ISNULL(NULLIF(MENU_ENGLISH,''),MENU_TEXT) ELSE ISNULL(NULLIF(MENU_CHINESE,''),MENU_TEXT) END AS TEN_MENU, MENU_PARENT AS  [ROOT], AN_HIEN AS  HIDE,MENU_INDEX AS STT_MENU INTO #MENUTMP FROM MENU_OEE
SELECT CONVERT(BIT,0) AS CHON,T.MS_CHA, T.ID_MENU, T.TEN_MENU, T.STT_MENU,CONVERT(INT,1) AS ID_PERMISION INTO	#TEMPT  FROM (
SELECT   NULL AS MS_CHA, CONVERT(NVARCHAR(250),'-1') AS  ID_MENU,CONVERT(NVARCHAR(250),'VietSoft - OEE') AS TEN_MENU  ,-1 AS STT_MENU
UNION   
SELECT   '-1' AS MS_CHA, CONVERT(NVARCHAR(50),MENU_ID) ,TEN_MENU, STT_MENU FROM #MENUTMP WHERE ISNULL([ROOT],'') = '' 
UNION   
SELECT CONVERT(NVARCHAR(250),[ROOT]) AS MS_CHA,CONVERT(NVARCHAR(250),MENU_ID),TEN_MENU, STT_MENU FROM #MENUTMP WHERE    [ROOT] IN (SELECT MENU_ID FROM #MENUTMP WHERE ISNULL([ROOT],'') = '')   
UNION 
SELECT    CONVERT(NVARCHAR(250),[ROOT]) AS MS_CHA,CONVERT(NVARCHAR(250),MENU_ID),TEN_MENU, STT_MENU FROM #MENUTMP WHERE  [ROOT] IN (SELECT MENU_ID   FROM #MENUTMP WHERE   [ROOT] IN(SELECT MENU_ID FROM #MENUTMP WHERE ISNULL([ROOT],'') = ''))    
UNION  
SELECT    CONVERT(NVARCHAR(250),[ROOT]) AS MS_CHA,CONVERT(NVARCHAR(250),MENU_ID),TEN_MENU, STT_MENU FROM #MENUTMP WHERE  [ROOT] IN   (  SELECT MENU_ID FROM #MENUTMP WHERE  [ROOT] IN (SELECT MENU_ID   FROM #MENUTMP WHERE   [ROOT] IN(SELECT MENU_ID FROM #MENUTMP WHERE ISNULL([ROOT],'') = '')) )
)T


UPDATE a
SET CHON = 1,ID_PERMISION = dbo.NHOM_MENU_OEE.ID_PERMISION
FROM #TEMPT a INNER JOIN dbo.NHOM_MENU_OEE ON dbo.NHOM_MENU_OEE.MENU_ID = a.ID_MENU AND GROUP_ID =@ID_NHOM
WHERE EXISTS
 (
    SELECT b.GROUP_ID,b.MENU_ID,ID_PERMISION
      FROM dbo.NHOM_MENU_OEE AS b
      WHERE @ID_NHOM = b.GROUP_ID AND a.ID_MENU =b.MENU_ID
  );
  IF(@Them = 1)
  SELECT * FROM #TEMPT
  ELSE
  SELECT * FROM #TEMPT WHERE CHON =1
END
GO

/****** Object:  StoredProcedure [dbo].[spEditNhomUser]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spEditNhomUser]
@GROUP_ID INT ='1',
@GROUP_NAME NVARCHAR(50) ='HCM - Administrator',
@DESCRIPTION NVARCHAR(100) = 'aa',
@sBT NVARCHAR(50) ='BTUseradmin'
AS 
BEGIN
CREATE TABLE #TEMUSER (
[USERNAME] [nvarchar] (50),
[FULL_NAME] [nvarchar] (50) ,
[DESCRIPTION] [nvarchar] (100) ,
[MS_TO] [int] NULL,
[USER_MAIL] [nvarchar] (150) ,
[MS_CONG_NHAN] [nvarchar] (9) ,
[ACTIVE] [bit] NULL
) ON [PRIMARY]
DECLARE @sSql nvarchar(4000)
SET @sSql = 'INSERT INTO #TEMUSER(USERNAME, FULL_NAME, DESCRIPTION, MS_TO, USER_MAIL,
                        MS_CONG_NHAN, ACTIVE ) SELECT USERNAME, FULL_NAME, DESCRIPTION, MS_TO, USER_MAIL,
                        MS_CONG_NHAN, ACTIVE  FROM ' + @sBT
EXEC (@sSql)
--set @sSql = 'DROP TABLE ' + @sBT
--EXEC (@sSql)
IF @GROUP_ID = -1
BEGIN
-- them itemmay
INSERT INTO dbo.NHOM ( GROUP_NAME, DESCRIPTION, TYPE_LIC )
VALUES  (@GROUP_NAME,@DESCRIPTION,NULL)
SET @GROUP_ID =( SELECT SCOPE_IDENTITY() )
END
ELSE
BEGIN
--sua item may
UPDATE dbo.NHOM
SET GROUP_NAME =@GROUP_NAME,
DESCRIPTION = @DESCRIPTION
WHERE GROUP_ID =@GROUP_ID
END	

IF (SELECT COUNT(*) FROM #TEMUSER) > 0
BEGIN
UPDATE A
SET A.FULL_NAME = B.FULL_NAME,
	A.DESCRIPTION = B.DESCRIPTION,
	A.MS_TO = B.MS_TO,
	A.USER_MAIL = B.USER_MAIL,
	A.MS_CONG_NHAN = B.MS_CONG_NHAN,
	A.ACTIVE = B.ACTIVE
FROM dbo.USERS A
INNER JOIN #TEMUSER B ON B.USERNAME = A.USERNAME

INSERT INTO	dbo.USERS ( USERNAME, GROUP_ID, FULL_NAME, PASS, DESCRIPTION,
                         MS_TO, USER_MAIL, MS_CONG_NHAN, ACTIVE )
SELECT A.USERNAME,@GROUP_ID,A.FULL_NAME,N'̨̦̪',A.DESCRIPTION,A.MS_TO,A.USER_MAIL,A.MS_CONG_NHAN,A.ACTIVE FROM #TEMUSER A WHERE NOT EXISTS (SELECT * FROM dbo.USERS B 
WHERE B.USERNAME =A.USERNAME)
END	
SELECT @GROUP_ID
END	



GO

/****** Object:  StoredProcedure [dbo].[SP_GET_MENU_OF_PARENT_OEE]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE procedure [dbo].[SP_GET_MENU_OF_PARENT_OEE]
@MENU_ID NVARCHAR (128) ='mnuOEE',
@USERNAME NVARCHAR (128) ='admin'
AS
BEGIN
SELECT dbo.MENU.MENU_ID, dbo.MENU.MENU_TEXT, dbo.MENU.MENU_ENGLISH, dbo.MENU.MENU_CHINESE, dbo.MENU.MENU_PARENT,dbo.MENU.MENU_LINE, dbo.MENU.MENU_INDEX, dbo.MENU.SHORT_KEY, dbo.MENU.DLL_NAME, dbo.MENU.PROJECT_NAME, 
dbo.MENU.CLASS_NAME, dbo.MENU.FUNCTION_NAME, dbo.MENU.MENU_NOTE, 1 AS ID_PERMISION
FROM dbo.MENU 
INNER JOIN dbo.NHOM_MENU ON NHOM_MENU.MENU_ID = MENU.MENU_ID 
INNER JOIN dbo.USERS ON dbo.NHOM_MENU.GROUP_ID = dbo.USERS.GROUP_ID
WHERE dbo.MENU.MENU_PARENT = @MENU_ID AND dbo.USERS.USERNAME = @USERNAME
AND ISNULL(AN_HIEN, 0) = 1 AND MENU_TYPE = -1
ORDER BY dbo.MENU.MENU_INDEX
END


GO

/****** Object:  StoredProcedure [dbo].[spEditProDucOrDer]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[spEditProDucOrDer]
	@IDPro BIGINT = -1,
	@PrOrNumber  nvarchar(50) ='123',
	@OrderDate  DATETIME = '2020-09-08 14:11:18.667',
	@StartDate  DATETIME = '2020-09-08 14:11:18.667',
	@DueDate  DATETIME = '2020-09-08 14:11:18.667',
	@Status  BIGINT =1,
	@Note NVARCHAR(500) ='test',
	@sBTDetail NVARCHAR(500)='TMPProDucDetailsadmin',
	@sBTSchedule NVARCHAR(500)='TMPProScheduleadmin'
AS 
BEGIN

CREATE TABLE #TEMPProDuctDetails (
[DetailsID] [bigint] NULL,
[PrOID] [bigint] NULL,
[ItemID] [bigint] NULL,
[ItemName] [nvarchar] (50),
[UOMID] [bigint] NULL,
[PlannedStartTime] [datetime] NULL,
[DueDate] [datetime] NULL,
[PlannedQuantity] [decimal] (18, 2) NULL,
[AllocatedQuantity] [int] NULL
) ON [PRIMARY]
DECLARE @sSql nvarchar(4000)
set @sSql = 'INSERT INTO #TEMPProDuctDetails SELECT DetailsID, PrOID, ItemID, ItemName, UOMID, PlannedStartTime, DueDate,
       PlannedQuantity, AllocatedQuantity FROM ' + @sBTDetail
EXEC (@sSql)

--set @sSql = 'DROP TABLE ' + @sBTDetail
--EXEC (@sSql)

CREATE TABLE #TEMPSchedule(
[ScheduleID] [bigint] NULL,
[PrOID] [bigint] NULL,
[DetailsID] [bigint] NULL,
[MS_TO] [int] NULL,
[MS_HE_THONG] [int] NULL,
[MS_MAY] [nvarchar] (30) NULL,
[CaID] [int] NULL,
[PlannedQuantity] [numeric] (18, 2) NULL,
[UOMID] [bigint] NULL,
[PlannedStartTime] [datetime] NULL,
[DueTime] [datetime] NULL,
[AllocatedQuantity] [int] NULL,
[StandardOutput] [numeric] (18, 2) NULL,
[MS_DV_TG_Output] [bigint] NULL,
[StandardSpeed] [numeric] (18, 2) NULL,
[MS_DV_TG_Speed] [bigint] NULL,
[WorkingCycle] [int] NULL,
[NumberPerCycle] [numeric] (18, 2) NULL,
[DownTimeRecord] [numeric] (18, 2) NULL
) ON [PRIMARY]

set @sSql = 'INSERT INTO #TEMPSchedule SELECT ScheduleID, PrOID, DetailsID, MS_TO, MS_HE_THONG, MS_MAY, CaID,
       PlannedQuantity, UOMID, PlannedStartTime, DueTime, ActualQuantity,
       StandardOutput, MS_DV_TG_Output, StandardSpeed, MS_DV_TG_Speed,
       WorkingCycle, NumberPerCycle, DownTimeRecord FROM ' + @sBTSchedule
EXEC (@sSql)
--set @sSql = 'DROP TABLE ' + @sBTSchedule
--EXEC (@sSql)
IF @IDPro = -1
BEGIN
INSERT INTO dbo.ProductionOrder ( PrOrNumber, OrderDate, StartDate, DueDate,
                                   Status, Note )
VALUES  ( @PrOrNumber, -- PrOrNumber - nvarchar(50)
          @OrderDate, -- OrderDate - datetime
          @StartDate, -- StartDate - datetime
          @DueDate, -- DueDate - datetime
          @Status, -- Status - bigint
          @Note  -- Note - nvarchar(500)
          )
SELECT @IDPro = SCOPE_IDENTITY()
END
ELSE
BEGIN
UPDATE dbo.ProductionOrder
SET PrOrNumber = @PrOrNumber,
OrderDate =@OrderDate,
StartDate =@StartDate,
[Status] =@Status,
Note =@Note
WHERE ID =@IDPro
END
-- update lại những dữ liệu tồn tại mà khác DetailsID - -1
UPDATE A	
SET A.ItemID =B.ItemID,
A.ItemName = B.ItemName,
A.UOMID =B.UOMID,
A.PlannedStartTime =B.PlannedStartTime,
A.DueDate =B.DueDate,
A.PlannedQuantity =B.PlannedQuantity
FROM dbo.PrODetails A
INNER JOIN #TEMPProDuctDetails B ON B.PrOID = A.PrOID AND B.DetailsID = A.DetailsID WHERE B.DetailsID > 0 AND A.PrOID = @IDPro
INSERT INTO dbo.PrODetails ( PrOID, ItemID, ItemName, UOMID, PlannedQuantity,
                              PlannedStartTime, DueDate )
SELECT  @IDPro, ItemID, ItemName, UOMID,PlannedQuantity, PlannedStartTime, DueDate FROM #TEMPProDuctDetails A WHERE NOT EXISTS(SELECT * FROM dbo.PrODetails B WHERE A.ItemID=B.ItemID AND B.PrOID =A.PrOID)
-- cập nhật lại dbo.ProSchedule


IF (SELECT COUNT(*) FROM #TEMPSchedule) > 0 

BEGIN
UPDATE A 
SET 
A.MS_HE_THONG=	B.MS_HE_THONG,
A.MS_MAY= 	B.MS_MAY, 
A.CaID= 	B.CaID, 
A.MS_TO=	B.MS_TO,
A.PlannedQuantity=	B.PlannedQuantity,
A.PlannedStartTime=	B.PlannedStartTime,
A.DueTime=	B.DueTime,
A.StandardSpeed=	B.StandardSpeed,
A.StandardOutput=	B.StandardOutput,
A.WorkingCycle=	B.WorkingCycle,
A.NumberPerCycle= 	B.NumberPerCycle, 
A.DownTimeRecord =	B.DownTimeRecord 
FROM dbo.ProSchedule A INNER JOIN #TEMPSchedule B ON A.PrOID =B.PrOID AND A.DetailsID = B.DetailsID AND A.ScheduleID =B.ScheduleID
IF @IDPro <> -1
BEGIN
UPDATE A
SET A.PrOID = B.DetailsID
FROM #TEMPProDuctDetails A
INNER JOIN dbo.PrODetails B ON B.ItemID = A.ItemID WHERE B.PrOID = @IDPro 

UPDATE A
SET A.DetailsID = B.PrOID	
FROM #TEMPSchedule A INNER JOIN #TEMPProDuctDetails B ON B.DetailsID = A.DetailsID WHERE A.PrOID IS  NULL
END	
--update ProSchedule
INSERT INTO dbo.ProSchedule ( PrOID, DetailsID, MS_HE_THONG, MS_MAY, CaID,
                               MS_TO, PlannedQuantity, PlannedStartTime,
                               DueTime, EndTime, ActualQty, StandardSpeed,
                               StandardOutput, ActualQuantity, WorkingCycle,
                               NumberPerCycle, DownTimeRecord )
SELECT @IDPro,DetailsID,MS_HE_THONG,MS_MAY,CaID,MS_TO,PlannedQuantity,PlannedStartTime,DueTime,NULL,NULL,StandardSpeed,StandardOutput,NULL,WorkingCycle,NumberPerCycle,DownTimeRecord FROM #TEMPSchedule WHERE PrOID IS NULL
END	
SELECT @IDPro
END	



GO

/****** Object:  StoredProcedure [dbo].[spGetItem]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[spGetItem]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@CoAll INT=2,
	@MS_MAY NVARCHAR(30) ='BTA-04-02'
AS 
---- @CoAll = 1 có all 
---- @CoAll = 0  
---- @CoAll = 2 lấy theo máy item
BEGIN
IF @CoAll = 1
BEGIN
SELECT * FROM (SELECT ID,ItemName  FROM dbo.Item
UNION
SELECT -1,N'< ALL >') A
ORDER BY A.ItemName
END
ELSE
IF	@CoAll = 0
BEGIN
SELECT ID,ItemCode,ItemName  FROM dbo.Item
ORDER BY ItemCode
END	
ELSE
BEGIN
------------lấy theo máy Item theo msMay
SELECT ID,A.ItemCode,ItemName  FROM dbo.Item A
INNER JOIN dbo.ItemMay B ON B.ItemID = A.ID
WHERE B.MS_MAY = @MS_MAY
ORDER BY A.ItemCode
END

END	


GO

/****** Object:  StoredProcedure [dbo].[spGetSatusProDuct]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetSatusProDuct]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@CoAll BIT=1
AS 
BEGIN
IF @CoAll = 1
BEGIN
SELECT * FROM (SELECT ID, CASE @NNgu WHEN 0 THEN NAME_STATUS WHEN 1 THEN ISNULL(NAME_STATUS_A,NAME_STATUS) WHEN 2 THEN	 ISNULL(NAME_STATUS_H,NAME_STATUS) END AS NAME_STATUS  FROM dbo.SatusProDuct
UNION
SELECT -1,N'< ALL >') A
ORDER BY A.ID
END
ELSE
BEGIN
SELECT ID, CASE @NNgu WHEN 0 THEN NAME_STATUS WHEN 1 THEN ISNULL(NAME_STATUS_A,NAME_STATUS) WHEN 2 THEN	 ISNULL(NAME_STATUS_H,NAME_STATUS) END AS NAME_STATUS  FROM dbo.SatusProDuct
ORDER BY ID
END	
END	


GO

/****** Object:  StoredProcedure [dbo].[spEditGroupDetails]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[spEditGroupDetails]
	@ID [bigint],
	@GroupName [nvarchar](250),
	@GroupNameA [nvarchar](250),
	@GroupNameH [nvarchar](250),
	@BasedUOMID [bigint],
	@Note [nvarchar] (500), 
	@sBT NVARCHAR(50)
AS 
BEGIN
CREATE TABLE #TEMPGroupDetails (
[ID] [bigint] ,
[UOMConversionGroupID] [bigint],
[UOMID] [bigint],
[UOMQuantity] [numeric] (18, 4) ,
[BasedUOMID] [bigint],
[BasedUOMQuantity] [numeric] (18, 4),
[Note] [nvarchar] (500),
CapacityUOM BIT
) ON [PRIMARY]
DECLARE @sSql nvarchar(4000)
set @sSql = 'INSERT INTO #TEMPGroupDetails(ID,UOMConversionGroupID, UOMID,
                                             UOMQuantity,
                                             BasedUOMQuantity, Note,CapacityUOM ) SELECT ID,UOMConversionGroupID, UOMID,
                                             UOMQuantity,
                                             BasedUOMQuantity, Note,CapacityUOM FROM ' + @sBT

EXEC (@sSql)
set @sSql = 'DROP TABLE ' + @sBT
EXEC (@sSql)
IF @ID = -1
BEGIN
-- them itemmay
INSERT INTO dbo.UOMConversionGroup ( GroupName,GroupNameA,GroupNameH, BasedUOMID, Note)
VALUES  (@GroupName,@GroupNameA,@GroupNameH,@BasedUOMID,@Note)
SET @ID = (SELECT SCOPE_IDENTITY())
END
ELSE
BEGIN
--sua item may
UPDATE dbo.UOMConversionGroup
SET GroupName =@GroupName,
GroupNameA =@GroupNameA,
GroupNameH =@GroupNameH,
BasedUOMID = @BasedUOMID,
Note = @Note
WHERE ID =@ID
END	

IF (SELECT COUNT(*) FROM #TEMPGroupDetails) > 0
BEGIN

UPDATE A
SET A.UOMID = B.UOMID,
	A.UOMQuantity = B.UOMQuantity,
	A.BasedUOMQuantity = B.BasedUOMQuantity,
	A.Note = B.Note,
	A.CapacityUOM = B.CapacityUOM
FROM dbo.UOMConversionGroupDetails A
INNER JOIN #TEMPGroupDetails B ON B.ID = A.ID

INSERT INTO	dbo.UOMConversionGroupDetails ( UOMConversionGroupID, UOMID,
                                             UOMQuantity,
                                             BasedUOMQuantity, Note,CapacityUOM )
SELECT @ID, A.UOMID, A.UOMQuantity,
       A.BasedUOMQuantity, A.Note,A.CapacityUOM FROM #TEMPGroupDetails A WHERE NOT EXISTS (SELECT * FROM dbo.UOMConversionGroupDetails B 
WHERE B.UOMConversionGroupID =@ID AND B.ID =A.ID)
END	
SELECT @ID
END	

GO

/****** Object:  StoredProcedure [dbo].[spGetUOMConversionGroupdetailByGroup]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetUOMConversionGroupdetailByGroup]
@IDConversionGroup BIGINT =6
AS 
BEGIN
SELECT DISTINCT A.ID,C.UOMName FROM dbo.UOMConversionGroupDetails A
INNER JOIN dbo.UOMConversionGroup B ON B.ID = A.UOMConversionGroupID
INNER JOIN dbo.UOM C ON C.ID = A.UOMID
WHERE A.UOMConversionGroupID = @IDConversionGroup OR @IDConversionGroup =-1
END

GO

/****** Object:  StoredProcedure [dbo].[spGetcbUOM]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetcbUOM]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@CoAll BIT=1
AS 
BEGIN
IF @CoAll = 1
BEGIN
SELECT ID,UOMName FROM dbo.UOM
ORDER BY UOMName
END
ELSE
BEGIN
SELECT ID,UOMName FROM dbo.UOM WHERE BasedUOM = 1
ORDER BY UOMName
END	
END	


GO

/****** Object:  StoredProcedure [dbo].[spItemGroup]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE	PROCEDURE [dbo].[spItemGroup]
	@Loai NVARCHAR(50) = 'grd',
	@ID BIGINT = 3,
	@ItemGroupName NVARCHAR(250) = '-1',
	@ItemGroupNameA NVARCHAR(250) = '-1',
	@ItemGroupNameH NVARCHAR(250) = '-1',
	@Note NVARCHAR(500) = '-1'
AS
BEGIN


--Get luoi 
IF UPPER(@Loai) = UPPER('Grd')
BEGIN
   SELECT ID, ItemGroupName,ItemGroupNameA,ItemGroupNameH, Note FROM dbo.ItemGroup ORDER BY ItemGroupName
END

--Save
IF UPPER(@Loai) = UPPER('Save')
BEGIN
--THEM
	IF @ID = -1
	BEGIN
		INSERT INTO	dbo.ItemGroup(ItemGroupName,ItemGroupNameA,ItemGroupNameH, Note)
		VALUES(@ItemGroupName,@ItemGroupNameA,@ItemGroupNameH, @Note)
		SELECT SCOPE_IDENTITY();
	END
--SUA
	ELSE
	BEGIN
		UPDATE dbo.ItemGroup SET ItemGroupName = @ItemGroupName,ItemGroupNameA = @ItemGroupNameA,ItemGroupNameH = @ItemGroupNameH, Note = @Note
		WHERE ID = @ID
		SELECT @ID;
	END
	END

--Delete 
IF UPPER(@Loai) = UPPER('Delete')
BEGIN
	IF EXISTS (SELECT	* FROM dbo.Item WHERE IDItemGroup = @ID)
	BEGIN
		SELECT 1 AS TT		
	END
	ELSE
	BEGIN
		DELETE dbo.ItemGroup WHERE ID = @ID
		DBCC CHECKIDENT (ItemGroup,RESEED,0)
		DBCC CHECKIDENT (ItemGroup,RESEED)
		SELECT 0 AS TT		
	END
END	

END


GO

/****** Object:  StoredProcedure [dbo].[spGetListChosseMay]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetListChosseMay]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@sBT nvarchar(50) ='TMPItemMayChooseadmin'
AS 
BEGIN
CREATE TABLE #TEMPItemMay (
[MS_MAY] [nvarchar] (30) NULL,
[StandardOutput] NUMERIC(18,2) NULL,
[MS_DV_TG_Output] [bigint] NULL,
[StandardSpeed] NUMERIC(18,2) NULL,
[MS_DV_TG_Speed] [bigint] NULL,
[DataCollectionCycle] [bigint] NULL,
[DownTimeRecord] [bigint] NULL,
[WorkingCycle] INT NULL,
 [NumberPerCyle] NUMERIC(18,2) NULL,
  [TimeSendMgs] NUMERIC(18,2) NULL
) ON [PRIMARY]
DECLARE @sSql nvarchar(4000)
set @sSql = 'INSERT INTO #TEMPItemMay SELECT  MS_MAY, StandardOutput, MS_DV_TG_Output, StandardSpeed,
       MS_DV_TG_Speed, DataCollectionCycle, DownTimeRecord, WorkingCycle,
       NumberPerCyle, TimeSendMgs  FROM ' + @sBT
EXEC (@sSql)
set @sSql = 'DROP TABLE ' + @sBT
EXEC (@sSql)
SELECT MS_MAY,TEN_MAY INTO #TMP FROM dbo.MGetMayUserNgay(GETDATE(),@username,-1,-1,-1,-1,'-1','-1', @NNgu)	
SELECT CONVERT(BIT,0) AS CHON, A.MS_MAY,A.TEN_MAY,StandardSpeed,DataCollectionCycle,WorkingCycle,NumberPerCyle,A.TimeSendMgs INTO #TEMP FROM dbo.MAY A
INNER JOIN #TMP B ON B.MS_MAY = A.MS_MAY
ORDER BY A.TEN_MAY

UPDATE A
set A.CHON = 1
FROM #TEMP A
INNER JOIN #TEMPItemMay B ON B.MS_MAY = A.MS_MAY
SELECT * FROM #TEMP ORDER BY TEN_MAY
END	



GO

/****** Object:  StoredProcedure [dbo].[spEditItemMay]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spEditItemMay]
	@IDItem BIGINT,
	@ItemCode  nvarchar(50),
	@ItemName  nvarchar(250),
	@ItemNameA  nvarchar(250),
	@ItemNameH  nvarchar(250),
	@OtherName  nvarchar(250),
	@Barcode  nvarchar(50),
	@IDItemGroup  BIGINT,
	@Description  nvarchar(50),
	@UOMConverionGroupID  BIGINT,
	@BasedUOM  BIGINT,
	@sBT NVARCHAR(50)
AS 
BEGIN
CREATE TABLE #TEMPItemMay (
[MS_MAY] [nvarchar] (30) NULL,
[StandardOutput] NUMERIC(18,2) NULL,
[MS_DV_TG_Output] [bigint] NULL,
[StandardSpeed] NUMERIC(18,2) NULL,
[MS_DV_TG_Speed] [bigint] NULL,
[DataCollectionCycle] [bigint] NULL,
[DownTimeRecord] [bigint] NULL,
[WorkingCycle] [int] NULL,
[NumberPerCyle] NUMERIC(18,2) NULL,
[TimeSendMgs] NUMERIC(18,2) NULL
) ON [PRIMARY]
DECLARE @sSql nvarchar(4000)
set @sSql = 'INSERT INTO #TEMPItemMay SELECT MS_MAY, StandardOutput, MS_DV_TG_Output, StandardSpeed,
       MS_DV_TG_Speed, DataCollectionCycle, DownTimeRecord, WorkingCycle,
       NumberPerCyle, TimeSendMgs FROM ' + @sBT
EXEC (@sSql)
set @sSql = 'DROP TABLE ' + @sBT
EXEC (@sSql)
IF @IDItem = -1
BEGIN
-- them itemmay
INSERT INTO dbo.Item (ItemCode, ItemName,ItemNameA,ItemNameH, OtherName, Barcode,
                        IDItemGroup, Description, UOMConverionGroupID,
                        UOM )
VALUES  (@ItemCode ,@ItemName,@ItemNameA,@ItemNameH,@OtherName, @Barcode ,@IDItemGroup,@Description ,@UOMConverionGroupID ,
@BasedUOM )
SET @IDItem =( SELECT SCOPE_IDENTITY() )
END
ELSE
BEGIN
--sua item may
UPDATE dbo.Item
SET 
ItemCode =@ItemCode,
ItemName =@ItemName,
ItemNameA =@ItemNameA,
ItemNameH =@ItemNameH,
OtherName =@OtherName,
Barcode =@Barcode,
IDItemGroup =@IDItemGroup, 
Description = @Description, 
UOMConverionGroupID =@UOMConverionGroupID,
UOM =@BasedUOM
WHERE ID =@IDItem
END	
IF (SELECT COUNT(*) FROM #TEMPItemMay) > 0
BEGIN
DELETE dbo.ItemMay WHERE ItemID =@IDItem
INSERT INTO	dbo.ItemMay(  MS_MAY, ItemID, StandardOutput, MS_DV_TG_Output,
                           StandardSpeed, MS_DV_TG_Speed, DataCollectionCycle,
                           DownTimeRecord, WorkingCycle, NumberPerCyle,
                           TimeSendMgs)
SELECT MS_MAY,@IDItem,StandardOutput, MS_DV_TG_Output, StandardSpeed, MS_DV_TG_Speed,
      DataCollectionCycle, DownTimeRecord, WorkingCycle, NumberPerCyle,
                           TimeSendMgs
      DownTimeRecord FROM #TEMPItemMay
END
ELSE
BEGIN
DELETE dbo.ItemMay WHERE ItemID =@IDItem
END
SELECT @IDItem
END	

GO

/****** Object:  StoredProcedure [dbo].[spGetMay]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[spGetMay]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =1,
	@CoAll INT =1
AS 
BEGIN
IF	@CoAll = 1
BEGIN
SELECT * FROM (
SELECT A.MS_MAY,A.TEN_MAY FROM dbo.MGetMayUserNgay(GETDATE(),@username,-1,-1,-1,-1,'-1','-1', @NNgu) A 	INNER JOIN dbo.ProductionRunDetails B ON B.MS_MAY = A.MS_MAY
UNION
SELECT '-1','< All >')T
ORDER BY T.TEN_MAY
END
ELSE
BEGIN
SELECT A.MS_MAY,A.TEN_MAY FROM dbo.MGetMayUserNgay(GETDATE(),@username,-1,-1,-1,-1,'-1','-1', @NNgu) A 	
ORDER BY A.TEN_MAY
END	
END	



GO

/****** Object:  StoredProcedure [dbo].[spGetItemMay]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetItemMay]
	@ItemID BIGINT = 15,
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@sBT NVARCHAR(50)='NO'
AS 
BEGIN
SELECT A.* INTO #MAY FROM dbo.MGetMayUserNgay(GETDATE(),@username,-1,-1,-1,-1,'-1','-1', @NNgu) A 	

DECLARE @DVT NVARCHAR(50)
SET @DVT = [dbo].[fnGetDVTCongSuat](@ItemID)

SELECT  A.MS_MAY AS 'DeviceID',A.MS_MAY,A.StandardOutput,A.MS_DV_TG_Output,A.StandardSpeed,A.MS_DV_TG_Speed,A.DataCollectionCycle,A.DownTimeRecord,A.WorkingCycle,A.NumberPerCyle,A.TimeSendMgs ,@DVT AS 'CapacityUOM' INTO #TMP FROM dbo.ItemMay A
INNER JOIN #MAY B ON B.MS_MAY = A.MS_MAY
WHERE A.ItemID = @ItemID
ORDER BY MS_MAY


IF	@sBT = 'NO'
BEGIN
SELECT * FROM #TMP
END
ELSE	
BEGIN
CREATE TABLE #TEMPItemMay
(
[CHON] [bit] NULL,
[MS_MAY] [nvarchar] (max),
[TEN_MAY] [nvarchar] (max),
[StandardSpeed] [real] NULL,
[DataCollectionCycle] [int] NULL,
[WorkingCycle] [int] NULL,
[NumberPerCyle] NUMERIC(18,2) NULL,
[TimeSendMgs] NUMERIC(18,2) NULL
) ON [PRIMARY] 
DECLARE @sSql nvarchar(4000)
set @sSql = 'INSERT INTO #TEMPItemMay SELECT * FROM ' + @sBT
EXEC (@sSql)
set @sSql = 'DROP TABLE ' + @sBT
EXEC (@sSql)

IF (SELECT COUNT(*) FROM #TEMPItemMay) > 0
BEGIN
SELECT A.* FROM #TMP A
INNER JOIN #TEMPItemMay B ON B.MS_MAY = A.MS_MAY
UNION
SELECT A.MS_MAY,A.MS_MAY,NULL AS StandardOutput,NULL AS MS_DV_TG_Output,A.StandardSpeed,NULL AS MS_DV_TG_Speed,A.DataCollectionCycle,NULL AS DownTimeRecord,A.WorkingCycle,A.NumberPerCyle,A.TimeSendMgs,@DVT AS 'CapacityUOM' FROM #TEMPItemMay A
WHERE NOT EXISTS (SELECT * FROM #TMP B WHERE B.MS_MAY = A.MS_MAY)
END
ELSE
BEGIN
DELETE #TMP
SELECT * FROM #TMP ORDER BY MS_MAY
END	
END	
END	





GO

/****** Object:  StoredProcedure [dbo].[spGetItemGroup]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetItemGroup]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@CoAll BIT=1
AS 
BEGIN
IF @CoAll = 1
BEGIN
SELECT * FROM (SELECT ID,CASE @NNgu WHEN 0 THEN ItemGroupName WHEN 1 THEN ISNULL(NULLIF(ItemGroupNameA,''),ItemGroupName) WHEN 2 THEN ISNULL(NULLIF(ItemGroupNameH,''),ItemGroupName) END AS   ItemGroupName FROM dbo.ItemGroup
UNION 
SELECT -1,'< All >')T
ORDER BY T.ItemGroupName


END
ELSE
BEGIN
SELECT ID,CASE @NNgu WHEN 0 THEN ItemGroupName WHEN 1 THEN ISNULL(NULLIF(ItemGroupNameA,''),ItemGroupName) WHEN 2 THEN ISNULL(NULLIF(ItemGroupNameH,''),ItemGroupName) END AS   ItemGroupName FROM dbo.ItemGroup
ORDER BY ItemGroupName
END	
END	


GO

/****** Object:  StoredProcedure [dbo].[spUOMConversionGroup]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


--SELECT ID, GroupName, Note FROM dbo.UOMConversionGroup
CREATE	PROCEDURE [dbo].[spUOMConversionGroup]
	@Loai NVARCHAR(50) = 'grd',
	@ID BIGINT = 3,
	@GroupName NVARCHAR(250) = '-1',
	@Note NVARCHAR(500) = '-1'
AS
BEGIN


--Get luoi 
IF UPPER(@Loai) = UPPER('Grd')
BEGIN
   SELECT ID, GroupName, Note FROM dbo.UOMConversionGroup ORDER BY GroupName
END

--Save
IF UPPER(@Loai) = UPPER('Save')
BEGIN
--THEM
	IF @ID = -1
	BEGIN
		INSERT INTO	dbo.UOMConversionGroup(GroupName, Note)
		VALUES(@GroupName, @Note)
		SELECT SCOPE_IDENTITY();
	END
--SUA
	ELSE
	BEGIN
		UPDATE dbo.UOMConversionGroup	SET GroupName = @GroupName,Note = @Note
		WHERE ID = @ID
		SELECT @ID;
	END
	END

--Delete 
IF UPPER(@Loai) = UPPER('Delete')
BEGIN
	IF EXISTS (SELECT * FROM dbo.UOMConversionGroupDetails WHERE UOMConversionGroupID = @ID)
	BEGIN
		SELECT 1 AS TT		
	END
	ELSE
	BEGIN
		DELETE dbo.UOMConversionGroup WHERE ID = @ID
		DBCC CHECKIDENT (UOMConversionGroup,RESEED,0)
		DBCC CHECKIDENT (UOMConversionGroup,RESEED)
		SELECT 0 AS TT		
	END
END	

END


GO

/****** Object:  StoredProcedure [dbo].[spGetUOMConversionGroup]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetUOMConversionGroup]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@CoAll BIT=1
AS 
BEGIN
IF @CoAll = 1
BEGIN
SELECT * FROM(
SELECT ID, CASE @NNgu WHEN 0 THEN GroupName WHEN 1 THEN ISNULL(NULLIF(GroupNameA,''),GroupName) WHEN 2 THEN ISNULL(NULLIF(GroupNameH,''),GroupName) END AS   GroupName FROM UOMConversionGroup
UNION 
SELECT -1,'< All >')T
ORDER BY T.GroupName;
END
ELSE
BEGIN
SELECT ID, CASE @NNgu WHEN 0 THEN GroupName WHEN 1 THEN ISNULL(NULLIF(GroupNameA,''),GroupName) WHEN 2 THEN ISNULL(NULLIF(GroupNameH,''),GroupName) END AS   GroupName FROM UOMConversionGroup
ORDER BY GroupName
END	
END	


GO

/****** Object:  StoredProcedure [dbo].[SP_GET_MENU_OEE]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE procedure [dbo].[SP_GET_MENU_OEE]
@USERNAME NVARCHAR (128) ='admin'
AS
BEGIN
SELECT A.MENU_ID, MENU_TEXT, MENU_ENGLISH, MENU_CHINESE, MENU_PARENT, 
MENU_LINE, MENU_INDEX, SHORT_KEY, DLL_NAME, PROJECT_NAME, 
CLASS_NAME, FUNCTION_NAME, MENU_NOTE,1 as ID_PERMISION
FROM dbo.REPORT_OEE A
ORDER BY A.MENU_INDEX
END






GO

/****** Object:  StoredProcedure [dbo].[spUOM]    Script Date: 29/03/2021 10:09:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE	PROCEDURE [dbo].[spUOM]
	@Loai NVARCHAR(50) = 'grd',
	@ID BIGINT = 3,
	@UOMCode NVARCHAR(50) = '-1',
	@UOMName NVARCHAR(250) = '-1',
	@UOMNameA NVARCHAR(250) = '-1',
	@UOMNameH NVARCHAR(250) = '-1',
	@Length NUMERIC(18, 2) = -1,
	@Width NUMERIC(18, 2) = -1,
	@Height NUMERIC(18, 2) = -1,
	@Volume NUMERIC(18, 2) = -1,
	@Weight NUMERIC(18, 2) = -1,
	@BasedUOM BIT = 0,
	@UOMNote NVARCHAR(500) = '-1'
AS
BEGIN


--Get luoi 
IF UPPER(@Loai) = UPPER('Grd')
BEGIN
   SELECT ID, UOMCode, UOMName,UOMNameA,UOMNameH, [Length], Width, Height, Volume, [Weight], BasedUOM,UOMNote FROM dbo.UOM ORDER BY UOMCode,UOMName
END

--Save
IF UPPER(@Loai) = UPPER('Save')
BEGIN
--THEM
	IF @ID = -1
	BEGIN
		INSERT INTO	dbo.UOM(UOMCode, UOMName,UOMNameA,UOMNameH, [Length], Width, Height, Volume, [Weight], BasedUOM,UOMNote)
		VALUES(@UOMCode,@UOMName,@UOMNameA,@UOMNameH ,@Length ,@Width ,@Height ,@Volume ,@Weight ,@BasedUOM,@UOMNote )
		SELECT SCOPE_IDENTITY();
	END
--SUA
	ELSE
	BEGIN
		UPDATE dbo.UOM	SET UOMCode = @UOMCode, UOMName = @UOMName, UOMNameA = @UOMNameA, UOMNameH = @UOMNameH, [Length] = @Length, Width = @Width, Height = @Height, Volume = @Volume, [Weight] = @Weight, BasedUOM = @BasedUOM,UOMNote = @UOMNote
		WHERE ID = @ID
		SELECT @ID;
	END
	END

--Delete 
IF UPPER(@Loai) = UPPER('Delete')
BEGIN
	IF EXISTS (SELECT * FROM dbo.UOMConversionGroupDetails WHERE UOMID = @ID)
	BEGIN
		SELECT 1 AS TT		
	END
	ELSE
	BEGIN
		DELETE dbo.UOM WHERE ID = @ID
		DBCC CHECKIDENT (UOM,RESEED,0)
		DBCC CHECKIDENT (UOM,RESEED)
		SELECT 0 AS TT		
	END
END	

END


GO

/****** Object:  StoredProcedure [dbo].[spGetUOM]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE	PROCEDURE [dbo].[spGetUOM]
    @Loai NVARCHAR(50) = 'Save'
AS
BEGIN
   SELECT ID, UOMCode, UOMName, Length, Width, Height, Volume, Weight, basedUOM FROM dbo.UOM		
END
GO

/****** Object:  StoredProcedure [dbo].[GetDON_VI_TINH_TOC_DO]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE proc [dbo].[GetDON_VI_TINH_TOC_DO]
@TYPE INT
AS
SELECT MS_DVT_TD,TEN_DVT_TD
 FROM dbo.DON_VI_TINH_TOC_DO
GO

/****** Object:  StoredProcedure [dbo].[spGetListProSchedule]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[spGetListProSchedule]
	@ItemID BIGINT =12,
    @PrOID BIGINT = 10079,
    @DetailsID BIGINT = 94,
    @UserName NVARCHAR(50) = 'admin',
    @NNgu INT = 0
AS
BEGIN
    SELECT A.*
    INTO #MAY
    FROM dbo.MGetMayUserNgay(GETDATE(), @UserName, '-1', -1, -1, '-1', '-1', '-1', @NNgu) A;


    SELECT ScheduleID,
           A.PrOID,
           A.DetailsID,
           MS_TO,
           A.MS_HE_THONG,
           A.MS_MAY,
           CaID,
           A.PlannedQuantity,
           B.UOMID,
           A.PlannedStartTime,
           DueTime,
           (
               SELECT SUM(ActualQuantity - ISNULL(T.DefectQuantity, 0))
               FROM dbo.ProductionRunDetails T
               WHERE T.PrOID = A.PrOID
                     AND T.ItemID = B.ItemID
                     AND T.MS_MAY = A.MS_MAY
           ) AS ActualQuantity,
           A.StandardOutput,
           C.MS_DV_TG_Output,
           A.StandardSpeed,
           C.MS_DV_TG_Speed,
           A.WorkingCycle,
           A.NumberPerCycle,
           A.DownTimeRecord,
           [dbo].[fnGetSumStandardOutput](B.ItemID, DATEDIFF(MINUTE, A.PlannedStartTime, A.DueTime) * A.StandardOutput) AS SumStandardOutput,
           [dbo].[fnGetDVTCongSuat](B.ItemID)AS CapacityUOM
    FROM dbo.ProSchedule A
        INNER JOIN dbo.PrODetails B
            ON B.DetailsID = A.DetailsID
        INNER JOIN dbo.ItemMay C
            ON C.ItemID = B.ItemID
               AND C.MS_MAY = A.MS_MAY
        INNER JOIN #MAY E
            ON E.MS_MAY = A.MS_MAY
    WHERE A.PrOID = @PrOID
          AND A.DetailsID = @DetailsID
		  ORDER BY A.PlannedQuantity DESC, E.TEN_MAY

END;



GO

/****** Object:  StoredProcedure [dbo].[spGetListProductionOrder]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetListProductionOrder]
	@TuNgay DATE = '10/19/2020',
	@DenNgay DATE  ='10/31/2020',
	@USERNAME NVARCHAR(250) ='admin',
	@NNgu INT = 0
AS 
BEGIN
SELECT ID, PrOrNumber, OrderDate, StartDate, DueDate, Status, Note FROM dbo.ProductionOrder
WHERE CONVERT(DATE,StartDate) BETWEEN @TuNgay AND @DenNgay 	
ORDER BY StartDate,PrOrNumber DESC
END
GO

/****** Object:  StoredProcedure [dbo].[spGetListPrODetails]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[spGetListPrODetails]
    @PrOID BIGINT = 10079 ,
    @USERNAME NVARCHAR(250) = 'admin' ,
    @NNgu INT = 0
AS
    BEGIN
         SELECT   A.DetailsID, A.PrOID, A.ItemID, ItemName, UOMID,
                A.PlannedStartTime, DueDate, A.PlannedQuantity, SUM(C.PlannedQuantity) AS ModerQuantity,
             SUM(B.ActualQuantity) AS AllocatedQuantity
        FROM    dbo.PrODetails A
				LEFT JOIN dbo.ProSchedule C ON C.DetailsID = A.DetailsID
                LEFT JOIN dbo.ProductionRunDetails B ON B.PrOID = B.PrOID AND C.MS_MAY =B.MS_MAY AND B.ItemID = A.ItemID

        WHERE   A.PrOID = @PrOID
        GROUP BY A.DetailsID, A.PrOID, A.ItemID, ItemName, UOMID,
                A.PlannedStartTime, DueDate, A.PlannedQuantity
        ORDER BY A.ItemName ASC,A.PlannedStartTime
    END	






	
GO

/****** Object:  StoredProcedure [dbo].[spGetItemByPro]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetItemByPro]
	@PrOID BIGINT =-1,
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0
AS 
BEGIN
SELECT A.ID, ISNULL(A.OtherName,CASE @NNgu WHEN 0 THEN A.ItemName WHEN 1 THEN ISNULL(NULLIF(A.ItemNameA,''),A.ItemName) ELSE ISNULL(NULLIF(A.ItemNameH,''),A.ItemName) END) AS ItemName FROM dbo.Item A
INNER JOIN dbo.PrODetails B ON A.ID = B.ItemID 
WHERE B.PrOID = @PrOID OR @PrOID = -1
END	



GO

/****** Object:  StoredProcedure [dbo].[spGetcbHeThongbySchedule]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetcbHeThongbySchedule]
 @Username NVARCHAR(50) ='admin',
 @NNgu INT = 0
AS
BEGIN
SELECT DISTINCT A.MS_HE_THONG,CASE @NNgu WHEN 0 THEN B.TEN_HE_THONG WHEN 1 THEN ISNULL(NULLIF(B.TEN_HE_THONG_ANH,''),B.TEN_HE_THONG) ELSE ISNULL(NULLIF(B.TEN_HE_THONG_HOA,''),B.TEN_HE_THONG) END AS TEN_HE_THONG FROM dbo.ProSchedule A
INNER JOIN dbo.HE_THONG B ON B.MS_HE_THONG = A.MS_HE_THONG
END
GO

/****** Object:  StoredProcedure [dbo].[spGetSLProSchedule]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetSLProSchedule]
@PrOID BIGINT =10053,
@ItemID BIGINT = 6,
@MS_MAY NVARCHAR(30) ='CHIE-ARA-001'
AS 
BEGIN
SELECT TOP 1 A.PlannedQuantity - (ISNULL(C.ActualQuantity,0) - ISNULL(C.DefectQuantity,0)) AS 'ActualQuantity',
       A.StandardSpeed, A.StandardOutput, A.WorkingCycle,
       A.NumberPerCycle FROM dbo.ProSchedule A
	   INNER JOIN dbo.PrODetails B ON B.DetailsID = A.DetailsID
	   LEFT JOIN dbo.ProductionRunDetails C ON C.MS_MAY = A.MS_MAY AND C.PrOID = B.PrOID AND C.ItemID = B.ItemID
	    WHERE A.PrOID = @PrOID AND B.ItemID = @ItemID AND A.MS_MAY =@MS_MAY

END


GO

/****** Object:  StoredProcedure [dbo].[spGetListChossePro]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


--SELECT * FROM TMPProMayChooseadmin

CREATE PROCEDURE [dbo].[spGetListChossePro]
	@MsHeThong INT = -1,
	@MsLoaiMay NVARCHAR(20) ='-1',
	@TNgay DATE = '03/01/2021',
	@DNgay DATE ='03/30/2021',
	@CoAll BIT	 = 0,
	@Username NVARCHAR(100) ='admin',
	@NNgu INT = 0,
	@SBT NVARCHAR(20) = 'TMPProMayChooseAdmin'
AS 
BEGIN

CREATE TABLE #PROOD
(
[DetailID] [bigint] NULL,
[PrOID] [bigint] NULL,
[ItemID] [bigint] NULL,
[MS_HE_THONG] [int] NULL,
[MS_MAY] [nvarchar] (30)  NULL,
[ActualQuantity] DECIMAL(18,2)
) ON [PRIMARY]
DECLARE @sSql nvarchar(4000)
set @sSql = 'INSERT INTO #PROOD (DetailID, PrOID, ItemID, MS_HE_THONG,
                                        MS_MAY,ActualQuantity) SELECT DetailID, PrOID, ItemID, MS_HE_THONG,
                                        MS_MAY,ActualQuantity FROM ' + @SBT 
EXEC (@sSql)

SELECT MS_MAY,TEN_MAY INTO #TMP FROM dbo.MGetMayUserNgay(@DNgay,@username,-1,@MsHeThong,-1,@MsLoaiMay,'-1','-1', @NNgu)	

SELECT CONVERT(BIT,0)AS CHON,
A.ID AS PrOID,
A.PrOrNumber,
B.ItemID,
E.ItemCode,
B.ItemName,
C.MS_MAY,
D.TEN_MAY,
B.PlannedStartTime,
C.DueTime,
C.PlannedQuantity ,
ISNULL(C.PlannedQuantity,0) -(ISNULL((SELECT TOP 1 ISNULL(ActualQuantity,0) - ISNULL(DefectQuantity,0) FROM dbo.ProductionRunDetails WHERE PrOID = B.PrOID AND ItemID = B.ItemID  AND MS_MAY = C.MS_MAY AND NOT EXISTS (SELECT * FROM #PROOD WHERE ProductionRunDetails.DetailID = #PROOD.DetailID)  ),0) + (SELECT ISNULL(SUM(ActualQuantity),0) FROM #PROOD WHERE PrOID = B.PrOID AND ItemID = B.ItemID  AND MS_MAY = C.MS_MAY /*and DetailID =-1*/)) AS SL_CHUA_SX INTO #TMPCHON  
FROM dbo.ProductionOrder A
INNER JOIN dbo.PrODetails B ON B.PrOID = A.ID
INNER JOIN dbo.ProSchedule C ON C.DetailsID = B.DetailsID
INNER JOIN #TMP D ON D.MS_MAY = C.MS_MAY
INNER JOIN dbo.Item E ON B.ItemID = E.ID
WHERE CONVERT(DATE,C.PlannedStartTime) BETWEEN @TNgay AND @DNgay AND A.Status IN (1,2)

ORDER BY A.PrOrNumber,B.ItemName,C.MS_MAY
--UPDATE A
--SET A.CHON = 1
--FROM #TMPCHON A INNER JOIN #PROOD ON #PROOD.ItemID = A.ItemID AND #PROOD.MS_MAY = A.MS_MAY AND #PROOD.PrOID = A.PrOID
SELECT * FROM #TMPCHON WHERE  SL_CHUA_SX > 0 OR @CoAll = 1
END	



GO

/****** Object:  StoredProcedure [dbo].[spChossePro]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



--SELECT * FROM TMPChonLuoiadmin
--SELECT * FROM TMPProMayChooseAdmin

CREATE PROCEDURE [dbo].[spChossePro]
@SBTLuoi NVARCHAR(20) = 'TMPChonLuoiadmin',
@SBT NVARCHAR(20) = 'TMPProMayChooseAdmin',
@TN DATETIME ='2020-08-24 00:00:00.000',
@DN DATETIME = '2020-08-24 00:00:00.000'
AS 
BEGIN
CREATE TABLE #CHONLUOI
(
[CHON] [bit] NULL,
[PrOID] [bigint] NULL,
[PrOrNumber] [nvarchar] (20) NULL,
[ItemID] [bigint] NULL,
[ItemName] [nvarchar] (50)  NULL,
[MS_MAY] [nvarchar] (30) NULL,
[TEN_MAY] [nvarchar] (50) NULL,
[PlannedStartTime] [datetime] NULL,
[DueTime] [datetime] NULL,
[PlannedQuantity] DECIMAL(18,2) NULL,
[SL_CHUA_SX] DECIMAL(18,2) NULL
) ON [PRIMARY]

DECLARE @sSql nvarchar(4000)
set @sSql = 'INSERT INTO #CHONLUOI  ( CHON, PrOID, PrOrNumber, ItemID, ItemName, MS_MAY,
                         TEN_MAY, PlannedStartTime, DueTime, PlannedQuantity,
                         SL_CHUA_SX ) SELECT  CHON, PrOID, PrOrNumber, ItemID, ItemName, MS_MAY,
                         TEN_MAY, PlannedStartTime, DueTime, PlannedQuantity,
                         SL_CHUA_SX  FROM ' + @SBTLuoi
EXEC (@sSql)
set @sSql = 'DROP TABLE ' + @SBTLuoi
EXEC (@sSql)

CREATE TABLE #PROOD
(
[DetailID] [bigint] NULL,
[PrOID] [bigint] NULL,
[ItemID] [bigint] NULL,
[MS_HE_THONG] [int] NULL,
[MS_MAY] [nvarchar] (30) NULL,
[TEN_MAY] [nvarchar] (30) NULL,
[OperatorID] [bigint] NULL,
[StartTime] [datetime] NULL,
[EndTime] [datetime] NULL,
[SumMinute] [int] NULL,
[ActualQuantity] NUMERIC(18,2) NULL,
[UOM] [bigint] NULL,
[ConvertQuantity] NVARCHAR(50),
[DefectQuantity] NUMERIC(18,2) NULL,
[ActualSpeed] NUMERIC(18,2) NULL,
[StandardSpeed] NUMERIC(18,2) NULL,
[StandardOutput] NUMERIC(18,2) NULL,
[WorkingCycle] [int] NULL,
[NumberPerCycle] NUMERIC(18,2) NULL
) ON [PRIMARY]

set @sSql = 'INSERT INTO #PROOD (DetailID, PrOID, ItemID, MS_HE_THONG,
                                        MS_MAY,TEN_MAY, OperatorID,StartTime,EndTime,
                                        SumMinute, ActualQuantity, UOM,
                                        ConvertQuantity, DefectQuantity,
                                        ActualSpeed, StandardSpeed,
                                        StandardOutput, WorkingCycle,
                                        NumberPerCycle) SELECT DetailID, PrOID, ItemID, MS_HE_THONG,
                                        MS_MAY,TEN_MAY, OperatorID,StartTime,EndTime,
                                        SumMinute, ActualQuantity, UOM,
                                        ConvertQuantity, DefectQuantity,
                                        ActualSpeed, StandardSpeed,
                                        StandardOutput, WorkingCycle,
                                        NumberPerCycle FROM ' + @SBT
UPDATE #PROOD SET StartTime = @TN ,EndTime = @DN

EXEC (@sSql)

--DELETE A	
--FROM #PROOD A 
--INNER JOIN  #CHONLUOI B ON A.PrOID = B.PrOID AND A.ItemID = B.ItemID AND A.MS_MAY =B.MS_MAY
--WHERE CHON = 0

--  set @sSql = 'DELETE A	
--FROM '+ @SBT +' A 
--INNER JOIN  #CHONLUOI B ON A.PrOID = B.PrOID AND A.ItemID = B.ItemID AND A.MS_MAY =B.MS_MAY
--WHERE CHON = 0'

--EXEC (@sSql)

INSERT INTO #PROOD (DetailID, PrOID, ItemID, MS_HE_THONG, MS_MAY,TEN_MAY, OperatorID,
                      StartTime, EndTime, SumMinute, ActualQuantity, UOM,
                      ConvertQuantity, DefectQuantity, ActualSpeed,
                      StandardSpeed, StandardOutput, WorkingCycle,
                      NumberPerCycle)

SELECT -1,C.PrOID,C.ItemID,D.MS_HE_THONG,D.MS_MAY,E.TEN_MAY,NULL,@TN,@DN,DATEDIFF(MINUTE,C.PlannedStartTime,D.DueTime),E.SL_CHUA_SX,B.UOMID, [dbo].[fnGetConvertQuantity](E.ItemID,E.SL_CHUA_SX)
,NULL,NULL,D.StandardSpeed,D.StandardOutput,D.WorkingCycle,D.NumberPerCycle
  FROM dbo.Item A 
  INNER JOIN dbo.UOMConversionGroupDetails B ON A.UOM = b.ID
  INNER JOIN dbo.PrODetails C ON  C.ItemID = A.ID
  INNER JOIN dbo.ProSchedule D ON D.DetailsID = C.DetailsID
  INNER JOIN  #CHONLUOI E ON E.MS_MAY = D.MS_MAY AND E.ItemID = C.ItemID AND E.PrOID = C.PrOID AND E.CHON = 1
  --AND NOT EXISTS (SELECT * FROM #PROOD F WHERE E.PrOID = F.PrOID AND E.ItemID =F.ItemID AND E.MS_MAY =F.MS_MAY)
set @sSql = 'delete  '+ @SBT
EXEC (@sSql)
set @sSql = 'INSERT INTO  '+ @SBT +'( DetailID, PrOID, ItemID,ItemCode,MS_HE_THONG,
                                        MS_MAY,TEN_MAY, OperatorID,StartTime,EndTime,
                                        SumMinute, ActualQuantity, UOM,
                                        ConvertQuantity, DefectQuantity,
                                        ActualSpeed, StandardSpeed,
                                        StandardOutput, WorkingCycle,
                                        NumberPerCycle) SELECT DetailID, PrOID, ItemID,(SELECT ItemCode FROM dbo.Item WHERE ID = ItemID) AS ItemCode, MS_HE_THONG,
                                        MS_MAY,MS_MAY, OperatorID,StartTime,EndTime,
                                        DATEDIFF(MINUTE,StartTime,EndTime), ActualQuantity, UOM,
                                        ConvertQuantity, DefectQuantity,
                                        ActualSpeed, StandardSpeed,
                                        StandardOutput, WorkingCycle,
                                        NumberPerCycle FROM #PROOD'
EXEC (@sSql)

END	





GO

/****** Object:  StoredProcedure [dbo].[spGetHeThongItem]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[spGetHeThongItem]
	@UserName NVARCHAR(50) ='admin',
	@lang INT =0 
AS
BEGIN

	SELECT A.* INTO #MAY FROM dbo.MGetMayUserNgay(GETDATE(),@username,'-1',-1,-1,'-1','-1','-1', @lang) A 	

	SELECT DISTINCT B.MS_HE_THONG,TEN_HE_THONG FROM dbo.ItemMay A
	INNER JOIN  #MAY B ON B.MS_MAY = A.MS_MAY
END
GO

/****** Object:  StoredProcedure [dbo].[spGetProDuctionOEE]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetProDuctionOEE]
	@CAID INT =1,
	@Ngay DATETIME ='2021-03-09 06:01:00.000',
	@USERNAME NVARCHAR(250) ='admin',
	@NNgu INT = 0
AS
    BEGIN
	SELECT A.* INTO #MAY FROM dbo.MGetMayUserNgay(GETDATE(),@username,'-1',-1,-1,'-1','-1','-1', @NNgu) A

        SELECT T.MS_MAY,T.CaSTT,
		CONVERT(NUMERIC(18,2),
		CONVERT(NUMERIC(18,2),SUM(T.TH))) AS TH, 
		CONVERT(NUMERIC(18,2),SUM(T.NPH))AS NPH ,
		CONVERT(NUMERIC(18,2),SUM(T.GPH)) AS GPH ,
		CONVERT(NUMERIC(18,2),SUM(T.DT)) AS DT,       
		CONVERT(NUMERIC(18,2), ( SUM(T.TH) / SUM(T.NPH) ) * 100) AS PE,
        CONVERT(NUMERIC(18,2),( SUM(T.TH) / SUM(T.GPH) ) * 100) AS OEE,
		CONVERT(NUMERIC(18,2),( SUM(T.DT) / SUM(T.GPH) ) * 100) AS DTP,
        CONVERT(NUMERIC(18,2),SUM(T.EL)) AS EL,
		CONVERT(NUMERIC(18,2),CONVERT(NUMERIC(18,2),SUM( T.EL - ( NPH - T.TH )))) AS ELV 
		INTO #TMP
        FROM    ( SELECT  A.MS_MAY,B.CaSTT, [dbo].[fnGetQuantityCapacity](ItemID,
                                                          ActualQuantity)/(A.StandardOutput * 60) AS TH,
                            ( ( DATEDIFF(MINUTE, A.StartTime, A.EndTime)
                                - ISNULL(( SELECT   SUM(B.THOI_GIAN_SUA_CHUA)
                                           FROM     dbo.THOI_GIAN_NGUNG_MAY B
                                           INNER JOIN  dbo.NGUYEN_NHAN_DUNG_MAY C ON C.MS_NGUYEN_NHAN = B.MS_NGUYEN_NHAN
										   WHERE     B.ProductionRunDetailsID = A.DetailID AND C.Planned = 2 
                                         ), 0) ) / 60 ) AS NPH,
                            DATEDIFF(MINUTE, A.StartTime, A.EndTime)/60 AS GPH,
                            ISNULL(( SELECT SUM(B.THOI_GIAN_SUA_CHUA)
                                     FROM   dbo.THOI_GIAN_NGUNG_MAY B
                                            INNER JOIN dbo.NGUYEN_NHAN_DUNG_MAY C ON C.MS_NGUYEN_NHAN = B.MS_NGUYEN_NHAN
                                     WHERE  B.ProductionRunDetailsID = A.DetailID AND   C.Planned = 2
                                   ), 0) / 60 AS DT,
                            ISNULL(( SELECT SUM(B.THOI_GIAN_SUA_CHUA)
                                     FROM   dbo.THOI_GIAN_NGUNG_MAY B
                                            INNER JOIN dbo.NGUYEN_NHAN_DUNG_MAY C ON C.MS_NGUYEN_NHAN = B.MS_NGUYEN_NHAN
                                     WHERE   B.ProductionRunDetailsID = A.DetailID
                                            AND C.Planned = 1
                                   ), 0) / 60 AS EL
                  FROM      dbo.ProductionRunDetails A
				  INNER JOIN dbo.ProductionRun B ON B.ID = A.ProductionRunID WHERE CONVERT(DATE, A.StartTime) = CONVERT(DATE, @Ngay)
                ) AS T WHERE T.CaSTT =@CAID GROUP BY T.MS_MAY,T.CaSTT   ORDER BY T.MS_MAY
				SELECT A.MS_MAY,B.TEN_MAY,CaSTT,TH,NPH,GPH,DT,PE,OEE,DTP,EL,ELV FROM #TMP A INNER JOIN  dbo.MAY B ON B.MS_MAY = A.MS_MAY ORDER BY B.TEN_MAY
	END	
	

GO

/****** Object:  StoredProcedure [dbo].[spGetcbUOMShortName]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetcbUOMShortName]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@CoAll BIT=1
AS 
BEGIN
IF @CoAll = 1
BEGIN
SELECT ID,ISNULL(UOMNote,UOMName) AS UOMName FROM dbo.UOM
ORDER BY UOMName
END
ELSE
BEGIN
SELECT ID,ISNULL(UOMNote,UOMName) AS UOMName FROM dbo.UOM WHERE BasedUOM = 1
ORDER BY UOMName
END	
END	


GO

/****** Object:  StoredProcedure [dbo].[spGetDownTimeType]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetDownTimeType]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@CoAll BIT=1
AS 
BEGIN
IF @CoAll = 1
BEGIN
SELECT * FROM (SELECT ID, CASE @NNgu WHEN 0 THEN DownTimeTypeName WHEN 1 THEN ISNULL(DownTimeTypeNameA,DownTimeTypeName) WHEN 2 THEN	 ISNULL(DownTimeTypeNameH,DownTimeTypeName) END AS DownTimeTypeName  FROM dbo.DownTimeType
UNION
SELECT -1,N'< ALL >') A
ORDER BY A.ID
END
ELSE
BEGIN
SELECT ID, CASE @NNgu WHEN 0 THEN DownTimeTypeName WHEN 1 THEN ISNULL(DownTimeTypeNameA,DownTimeTypeName) WHEN 2 THEN	 ISNULL(DownTimeTypeNameH,DownTimeTypeName) END AS DownTimeTypeName  FROM dbo.DownTimeType
ORDER BY ID
END	
END	


GO

/****** Object:  StoredProcedure [dbo].[spDownTimeType]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE	PROCEDURE [dbo].[spDownTimeType]
	@Loai NVARCHAR(50) = 'grd',
	@ID BIGINT = 3,
	@DownTimeTypeName NVARCHAR(250) = '-1',
	@DownTimeTypeNameA NVARCHAR(250) = '-1',
	@DownTimeTypeNameH NVARCHAR(250) = '-1',
	@Note NVARCHAR(500) = '-1'
AS
BEGIN


--Get luoi 
IF UPPER(@Loai) = UPPER('Grd')
BEGIN
   SELECT ID, DownTimeTypeName, DownTimeTypeNameA, DownTimeTypeNameH, Note FROM dbo.DownTimeType ORDER BY DownTimeTypeName
END

--Save
IF UPPER(@Loai) = UPPER('Save')
BEGIN
--THEM
	IF @ID = -1
	BEGIN
		INSERT INTO	dbo.DownTimeType ( DownTimeTypeName, DownTimeTypeNameA,
		                            DownTimeTypeNameH, Note)
		VALUES(@DownTimeTypeName,@DownTimeTypeNameA,@DownTimeTypeNameH, @Note)
		SELECT SCOPE_IDENTITY();
	END
--SUA
	ELSE
	BEGIN
		UPDATE dbo.DownTimeType SET DownTimeTypeName = @DownTimeTypeName,DownTimeTypeNameA = @DownTimeTypeNameA,DownTimeTypeNameH = @DownTimeTypeNameH, Note = @Note
		WHERE ID = @ID
		SELECT @ID;
	END
	END

--Delete 
IF UPPER(@Loai) = UPPER('Delete')
BEGIN
	IF EXISTS (SELECT	* FROM dbo.NGUYEN_NHAN_DUNG_MAY WHERE DownTimeTypeID = @ID)
	BEGIN
		SELECT 1 AS TT		
	END
	ELSE
	BEGIN
		DELETE dbo.DownTimeType WHERE ID = @ID
		DBCC CHECKIDENT (DownTimeType,RESEED,0)
		DBCC CHECKIDENT (DownTimeType,RESEED)
		SELECT 0 AS TT		
	END
END	

END


GO

/****** Object:  StoredProcedure [dbo].[spDownTimeCause]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE	PROCEDURE [dbo].[spDownTimeCause]
	@Loai NVARCHAR(50) = 'grd',
	@ID INT = 3,
	@TEN_NGUYEN_NHAN NVARCHAR(250) = '-1',
	@TEN_NGUYEN_NHANA NVARCHAR(250) = '-1',
	@DownTimeTypeID INT = '-1',
	@HU_HONG BIT =1, 
	@BTDK BIT = 1,
	@MAC_DINH BIT =1 ,
	@CauseCode NVARCHAR(50) ='',
	@Planned INT =1,
	 @NNgu INT = 0
AS
BEGIN
--Get luoi
IF UPPER(@Loai) = UPPER('Grd')
BEGIN
	SELECT MS_NGUYEN_NHAN, TEN_NGUYEN_NHAN, TEN_NGUYEN_NHAN_ANH, ISNULL(HU_HONG,0) AS HU_HONG, ISNULL(BTDK,0) AS BTDK,
            ISNULL(MAC_DINH,0) AS MAC_DINH,CauseCode,Planned,C.StopTypeName, DownTimeTypeID,  CASE @NNgu WHEN 1 THEN B.DownTimeTypeName WHEN 2 THEN ISNULL(NULLIF(B.DownTimeTypeNameA, ''), B.DownTimeTypeName) ELSE ISNULL(NULLIF(B.DownTimeTypeNameH, ''), B.DownTimeTypeName)
            END AS DownTimeTypeName 
 FROM dbo.NGUYEN_NHAN_DUNG_MAY A 
 INNER JOIN dbo.DownTimeType B ON B.ID = A.DownTimeTypeID
 INNER JOIN dbo.StopType C ON C.ID = A.Planned
 ORDER BY TEN_NGUYEN_NHAN
END
--Save
IF UPPER(@Loai) = UPPER('Save')
BEGIN
--THEM
	IF @ID = -1
	BEGIN
		INSERT INTO	dbo.NGUYEN_NHAN_DUNG_MAY ( TEN_NGUYEN_NHAN, HU_HONG, BTDK,
		                                    TEN_NGUYEN_NHAN_ANH, MAC_DINH,CauseCode, Planned,
		                                    DownTimeTypeID )
		VALUES(@TEN_NGUYEN_NHAN, @HU_HONG, @BTDK,
		                                    @TEN_NGUYEN_NHANA, @MAC_DINH,@CauseCode, @Planned,
		                                    @DownTimeTypeID)
		SELECT SCOPE_IDENTITY();
	END
--SUA
	ELSE
	BEGIN
		UPDATE dbo.NGUYEN_NHAN_DUNG_MAY SET
		TEN_NGUYEN_NHAN =@TEN_NGUYEN_NHAN, HU_HONG=@HU_HONG, BTDK=@BTDK,
		                                    TEN_NGUYEN_NHAN_ANH = @TEN_NGUYEN_NHANA, MAC_DINH =@MAC_DINH, Planned =@Planned,
		                                    DownTimeTypeID = @DownTimeTypeID,CauseCode =@CauseCode
		WHERE MS_NGUYEN_NHAN = @ID
		SELECT @ID;
	END
	END

--Delete 
IF UPPER(@Loai) = UPPER('Delete')
BEGIN
	IF EXISTS (SELECT	* FROM dbo.THOI_GIAN_NGUNG_MAY WHERE MS_NGUYEN_NHAN = @ID)
	BEGIN
		SELECT 1 AS TT		
	END
	ELSE
	BEGIN
		DELETE dbo.NGUYEN_NHAN_DUNG_MAY WHERE MS_NGUYEN_NHAN = @ID
		DBCC CHECKIDENT (NGUYEN_NHAN_DUNG_MAY,RESEED,0)
		DBCC CHECKIDENT (NGUYEN_NHAN_DUNG_MAY,RESEED)
		SELECT 0 AS TT		
	END
END	

END


GO

/****** Object:  StoredProcedure [dbo].[spViewLogCmb]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



--SELECT * FROM dbo.USERS
CREATE PROCEDURE [dbo].[spViewLogCmb]
	@CoAll INT = 1,
    @NNgu INT = 0,
	@UName NVARCHAR(50) = 'CNO22'
AS
BEGIN

SELECT DISTINCT T1.MENU_ID INTO #MENUTMP FROM dbo.NHOM_MENU   T1 INNER JOIN dbo.USERS T2 ON T2.GROUP_ID = T1.GROUP_ID WHERE T2.USERNAME = @UName



--exec GetNhaXuongTreeList 0,'administrator',1
SELECT * INTO #TMP FROM (
SELECT T2.MENU_ID,
CASE @NNgu WHEN 0 THEN T2.MENU_TEXT WHEN 1 THEN	 T2.MENU_ENGLISH ELSE T2.MENU_CHINESE END AS MENU_TEXT, 
CASE @NNgu WHEN 0 THEN T3.VIETNAM WHEN 1 THEN	 T3.ENGLISH ELSE T3.CHINESE END AS TEN_FORMS,
T2.MENU_PARENT
FROM dbo.CHI_TIET_FORMS T1 INNER JOIN dbo.MENU T2 ON T1.MENU_ID = T2.MENU_ID INNER JOIN (SELECT * FROM dbo.LANGUAGES WHERE FORM = KEYWORD) T3 ON T1.FORM_NAME = T3.FORM INNER JOIN #MENUTMP T4 ON T2.MENU_ID = T4.MENU_ID
WHERE LOG_VIEW = 1
UNION	
SELECT MENU_ID ,
CASE @NNgu WHEN 0 THEN T2.MENU_TEXT WHEN 1 THEN	 T2.MENU_ENGLISH ELSE T2.MENU_CHINESE END AS MENU_TEXT, 
NULL AS TEN_FORMS_VIET,NULL AS MENU_PARENT
FROM dbo.MENU T2 WHERE MENU_ID IN (
SELECT T2.MENU_PARENT
FROM dbo.CHI_TIET_FORMS T1 INNER JOIN dbo.MENU T2 ON T1.MENU_ID = T2.MENU_ID INNER JOIN #MENUTMP T3 ON T2.MENU_ID = T3.MENU_ID
WHERE LOG_VIEW = 1
))T1

IF @CoAll = 0 
BEGIN
    SELECT * FROM #TMP ORDER BY MENU_TEXT
END
ELSE	
BEGIN
    SELECT MENU_ID, MENU_TEXT, TEN_FORMS, ISNULL(MENU_PARENT,-1) AS MENU_PARENT FROM #TMP 
	UNION	SELECT	'-1',' < ALL > ',NULL,NULL
	ORDER BY MENU_TEXT
END
	


END
GO

/****** Object:  StoredProcedure [dbo].[spViewLogData]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



--SELECT * FROM dbo.USERS
CREATE PROCEDURE [dbo].[spViewLogData]
	@MenuView NVARCHAR(50) = 'mnuHeThong',
	@TNgay DATETIME = '12/15/2001',
	@DNgay DATETIME = '12/30/2020',
	@NNgu INT = 0
AS
BEGIN
/*
@MenuView NVARCHAR(50) = '-1' coi all thao tac log -- lấy du liệu trong table W_LOG      
mnuWork	2. 2. Danh mục công việc -- from  frmDanhmuccongviec
mnuMaintenanceForm	2. 6. Hình thức / Loai bảo trì -- from  frmBaoTri
mnuArea		2.19. Địa điểm hoạt động   --  frmBranch
mnuHeThong	2. 8. Dây chuyền	-- frmDanhmuchethong
*/

--SELECT * FROM dbo.MENU ORDER BY MENU_TEXT
--Lấy nn form
SELECT FORM, T2.MENU_ID,
CASE @NNgu WHEN 0 THEN VIETNAM WHEN 1 THEN ENGLISH ELSE CHINESE END AS TEN_FORMS
, MENU_TEXT
INTO #L_TMP FROM dbo.LANGUAGES  T1 
LEFT JOIN 	(SELECT FORM_NAME,CASE 0 WHEN 0 THEN T2.MENU_TEXT WHEN 1 THEN	 T2.MENU_ENGLISH ELSE T2.MENU_CHINESE END AS MENU_TEXT,T1.MENU_ID FROM dbo.CHI_TIET_FORMS T1 INNER JOIN dbo.MENU T2 ON T1.MENU_ID = T2.MENU_ID WHERE LOG_VIEW = 1) T2 ON T1.FORM = T2.FORM_NAME 
WHERE FORM = KEYWORD


DECLARE @Them NVARCHAR(10) ,@Sua NVARCHAR(10),@Xoa  NVARCHAR(10)

IF @NNgu = 0 
BEGIN
	SET @Them = N'Thêm'
	SET	@Sua = N'Sửa'
	SET @Xoa = N'Xoá'
END
ELSE
BEGIN
	SET @Them = N'Add'
	SET	@Sua = N'Edit'
	SET @Xoa = N'Delete'    
END

IF @MenuView = '-1' 
BEGIN
	SELECT DISTINCT 
	ROW_NUMBER() OVER (	ORDER BY CONVERT(DATETIME, CONVERT(VARCHAR,T1.NGAY,120))  DESC,
	ISNULL(T2.MENU_TEXT,ISNULL(T2.TEN_FORMS,T1.FORM_NAME)),
	TEN_FORMS) AS STT,
	ISNULL(T2.MENU_TEXT,ISNULL(T2.TEN_FORMS,T1.FORM_NAME)) AS MENU_TEXT,
	ISNULL(T2.TEN_FORMS,T1.FORM_NAME) AS TEN_FORMS,T1.USER_SIGN,CONVERT(DATETIME, CONVERT(VARCHAR,T1.NGAY,120))   AS CREATEDATE, CASE T1.THAOTAC WHEN 1 THEN @Them WHEN 2 THEN @Sua WHEN 3 THEN @Xoa END AS THAOTAC , CONVERT(INT,ISNULL(T1.THAOTAC,0)) AS TT,T2.MENU_ID
	FROM dbo.W_LOG T1 LEFT JOIN #L_TMP T2 ON T1.FORM_NAME = T2.FORM 
	WHERE CONVERT(DATE,T1.NGAY) BETWEEN @TNgay AND @DNgay
	ORDER BY CONVERT(DATETIME, CONVERT(VARCHAR,T1.NGAY,120))  DESC,
	ISNULL(T2.MENU_TEXT,ISNULL(T2.TEN_FORMS,T1.FORM_NAME)),
	TEN_FORMS
	

END

--mnuWork	2. 2. Danh mục công việc
BEGIN
IF @MenuView = 'mnuWork' 
BEGIN
SELECT DISTINCT T1.MS_CV,T1.MO_TA_CV, T1.MO_TA_CV_ANH, T1.KY_HIEU_CV, T1.AN_TOAN, T1.TEN_LOAI_MAY, T1.TEN_LOAI_CV, T1.TEN_CHUYEN_MON, T1.TEN_BAC_THO, T1.SO_NGUOI, T1.THOI_GIAN_DU_KIEN, T1.THAO_TAC, T1.TIEU_CHUAN_KT, T1.YEU_CAU_NS, T1.YEU_CAU_DUNG_CU, T1.GHI_CHU, T1.PATH_HD, T1.USER_SIGN, T1.CREATEDATE, T1.THAOTAC,TT  INTO	  #TmpWork
FROM (
	SELECT T1.MS_CV,MO_TA_CV, MO_TA_CV_ANH, KY_HIEU_CV, AN_TOAN,T2.TEN_LOAI_MAY,T4.TEN_LOAI_CV,T5.TEN_CHUYEN_MON, T3.TEN_BAC_THO, SO_NGUOI,THOI_GIAN_DU_KIEN,THAO_TAC,  TIEU_CHUAN_KT,YEU_CAU_NS, YEU_CAU_DUNG_CU,  T1.GHI_CHU, PATH_HD,T1.USER_SIGN, T1.CREATEDATE,
	CASE T1.THAOTAC WHEN 1 THEN @Them WHEN 2 THEN @Sua WHEN 3 THEN @Xoa END AS THAOTAC , T1.THAOTAC AS TT
	FROM dbo.W_CONG_VIEC T1 LEFT JOIN dbo.LOAI_MAY T2 ON T2.MS_LOAI_MAY = T1.MS_LOAI_MAY LEFT JOIN dbo.BAC_THO T3 ON T3.MS_BAC_THO = T1.MS_BAC_THO LEFT JOIN dbo.LOAI_CONG_VIEC T4 ON T4.MS_LOAI_CV = T1.MS_LOAI_CV LEFT JOIN dbo.CHUYEN_MON T5 ON T5.MS_CHUYEN_MON = T1.MS_CHUYEN_MON
	WHERE CONVERT(DATE,T1.CREATEDATE) BETWEEN @TNgay AND @DNgay
	UNION	
	SELECT T1.MS_CV,MO_TA_CV, MO_TA_CV_ANH, KY_HIEU_CV, AN_TOAN,T2.TEN_LOAI_MAY,T4.TEN_LOAI_CV,T5.TEN_CHUYEN_MON, T3.TEN_BAC_THO, SO_NGUOI,THOI_GIAN_DU_KIEN,THAO_TAC,  TIEU_CHUAN_KT,YEU_CAU_NS, YEU_CAU_DUNG_CU,  T1.GHI_CHU, PATH_HD, NULL AS USER_SIGN,NULL AS CREATEDATE, NULL THAOTAC , CONVERT(INT,0) AS TT
	FROM dbo.CONG_VIEC T1 LEFT JOIN dbo.LOAI_MAY T2 ON T2.MS_LOAI_MAY = T1.MS_LOAI_MAY LEFT JOIN dbo.BAC_THO T3 ON T3.MS_BAC_THO = T1.MS_BAC_THO LEFT JOIN dbo.LOAI_CONG_VIEC T4 ON T4.MS_LOAI_CV = T1.MS_LOAI_CV LEFT JOIN dbo.CHUYEN_MON T5 ON T5.MS_CHUYEN_MON = T1.MS_CHUYEN_MON
	WHERE T1.MS_CV IN(SELECT MS_CV FROM dbo.W_CONG_VIEC WHERE CONVERT(DATE,CREATEDATE) BETWEEN @TNgay AND @DNgay )
	) T1

	SELECT T1.MS_CV, T1.MO_TA_CV, T1.MO_TA_CV_ANH, T1.KY_HIEU_CV, T1.AN_TOAN, T1.TEN_LOAI_MAY, T1.TEN_LOAI_CV, T1.TEN_CHUYEN_MON, T1.TEN_BAC_THO, T1.SO_NGUOI, T1.THOI_GIAN_DU_KIEN, T1.THAO_TAC, T1.TIEU_CHUAN_KT, T1.YEU_CAU_NS, T1.YEU_CAU_DUNG_CU, T1.GHI_CHU, T1.PATH_HD, T1.USER_SIGN, T1.CREATEDATE, T1.THAOTAC, T1.TT FROM #TmpWork T1 ORDER BY  (SELECT MAX(T2.CREATEDATE) FROM #TmpWork T2 WHERE T1.MS_CV = T2.MS_CV) DESC, ISNULL(CREATEDATE,GETDATE()) DESC	
END
END

--mnuMaintenanceForm	2. 6. Hình thức / Loai bảo trì
BEGIN
IF @MenuView = 'mnuMaintenanceForm' 
BEGIN
SELECT DISTINCT T1.TEN_HT_BT, T1.TEN_LOAI_BT, T1.THU_TU, T1.GHI_CHU, T1.HU_HONG, T1.USER_SIGN, T1.CREATEDATE, T1.THAOTAC, TT, T1.MS_HT_BT,T1.MS_LOAI_BT  INTO	  #TmpMaintenanceForm 
FROM 
(
	SELECT DISTINCT	T2.TEN_HT_BT, T1.TEN_LOAI_BT, T1.THU_TU, T1.GHI_CHU, T1.HU_HONG,T1.MS_HT_BT, MS_LOAI_BT, T1.FORM_NAME, T1.USER_SIGN, T1.CREATEDATE, CASE T1.THAO_TAC WHEN 1 THEN @Them WHEN 2 THEN @Sua WHEN 3 THEN @Xoa END AS THAOTAC  , T1.THAO_TAC AS TT  
	FROM W_LOAI_BAO_TRI T1 INNER JOIN dbo.HINH_THUC_BAO_TRI T2 ON T1.MS_HT_BT = T2.MS_HT_BT 
	WHERE CONVERT(DATE,CREATEDATE) BETWEEN @TNgay AND @DNgay
	UNION
	SELECT DISTINCT	T2.TEN_HT_BT, T1.TEN_LOAI_BT, T1.THU_TU, T1.GHI_CHU, T1.HU_HONG,T1.MS_HT_BT, MS_LOAI_BT, NULL  FORM_NAME, NULL USER_SIGN, NULL AS CREATEDATE, NULL THAOTAC , CONVERT(INT,0) AS TT  
	FROM LOAI_BAO_TRI T1 INNER JOIN dbo.HINH_THUC_BAO_TRI T2 ON T1.MS_HT_BT = T2.MS_HT_BT  
	WHERE T1.MS_LOAI_BT IN(SELECT MS_LOAI_BT FROM dbo.W_LOAI_BAO_TRI WHERE CONVERT(DATE,CREATEDATE) BETWEEN @TNgay AND @DNgay)
) T1
	ORDER BY  MS_HT_BT, MS_LOAI_BT,TT DESC, CREATEDATE DESC	

	SELECT T1.MS_HT_BT,TEN_HT_BT,T1.MS_LOAI_BT, TEN_LOAI_BT, THU_TU, GHI_CHU, HU_HONG, USER_SIGN, CREATEDATE, THAOTAC,TT FROM #TmpMaintenanceForm T1
	ORDER BY  (SELECT MAX(T2.CREATEDATE) FROM #TmpMaintenanceForm T2 WHERE T1.MS_HT_BT = T2.MS_HT_BT AND  T1.MS_LOAI_BT = T2.MS_LOAI_BT ) DESC, ISNULL(CREATEDATE,GETDATE()) DESC	
END
END

--mnuArea		2.19. Địa điểm hoạt động
BEGIN
IF @MenuView = 'mnuArea' 
BEGIN

SELECT T1.MS_CHA, T1.TEN_NX_CHA, T1.MS_N_XUONG, T1.Ten_N_XUONG, T1.TEN_N_XUONG_A, T1.TEN_N_XUONG_H, T1.TRU_SO, T1.NGUOI_DAI_DIEN, T1.DIEN_THOAI, T1.DIA_CHI, T1.DIEN_TICH, T1.KHOANG_CACH, T1.GHI_CHU, T1.TEN_DON_VI, T1.USER_SIGN, T1.CREATEDATE, T1.THAOTAC,  T1.TT  INTO #TmpArea	 FROM 
(
	SELECT ISNULL(MS_CHA,T1.MS_N_XUONG) AS MS_CHA,(SELECT T2.Ten_N_XUONG FROM dbo.NHA_XUONG T2 WHERE T2.MS_N_XUONG = ISNULL(T1.MS_CHA,T1.MS_N_XUONG)) AS TEN_NX_CHA, MS_N_XUONG,  Ten_N_XUONG, TEN_N_XUONG_A, TEN_N_XUONG_H, TRU_SO, NGUOI_DAI_DIEN, DIEN_THOAI, DIA_CHI, DIEN_TICH, KHOANG_CACH, GHI_CHU, (SELECT T2.TEN_DON_VI FROM dbo.DON_VI T2 WHERE T2.MS_DON_VI =  T1.MS_DON_VI) AS TEN_DON_VI, USER_SIGN,  CREATEDATE, CASE T1.THAO_TAC WHEN 1 THEN @Them WHEN 2 THEN @Sua WHEN 3 THEN @Xoa END AS THAOTAC , T1.THAO_TAC AS TT 
	FROM W_NHA_XUONG T1
	WHERE CONVERT(DATE,CREATEDATE) BETWEEN @TNgay AND @DNgay
	UNION	

	SELECT ISNULL(MS_CHA,T1.MS_N_XUONG) AS MS_CHA,(SELECT T2.Ten_N_XUONG FROM dbo.NHA_XUONG T2 WHERE T2.MS_N_XUONG = ISNULL(T1.MS_CHA,T1.MS_N_XUONG)) AS TEN_NX_CHA,  MS_N_XUONG, Ten_N_XUONG, TEN_N_XUONG_A, TEN_N_XUONG_H, TRU_SO, NGUOI_DAI_DIEN, DIEN_THOAI, DIA_CHI, DIEN_TICH, KHOANG_CACH, GHI_CHU, (SELECT T2.TEN_DON_VI FROM dbo.DON_VI T2 WHERE T2.MS_DON_VI =  T1.MS_DON_VI) AS TEN_DON_VI, NULL USER_SIGN, NULL AS CREATEDATE, NULL THAOTAC , CONVERT(INT,0) AS TT FROM dbo.NHA_XUONG T1
	WHERE T1.MS_N_XUONG IN(SELECT MS_N_XUONG FROM dbo.W_NHA_XUONG WHERE CONVERT(DATE,CREATEDATE) BETWEEN @TNgay AND @DNgay)
	
) T1

	SELECT *		 FROM #TmpArea T1 ORDER BY  (SELECT MAX(T2.CREATEDATE) FROM #TmpArea T2 WHERE T1.MS_N_XUONG = T2.MS_N_XUONG ) DESC, ISNULL(CREATEDATE,GETDATE()) DESC	

END
END

--mnuHeThong	2. 8. Dây chuyền
BEGIN
IF @MenuView = 'mnuHeThong' 
BEGIN
SELECT T1.MS_HE_THONG, T1.TEN_HE_THONG, T1.GHI_CHU, T1.NO_LINE, 
T1.USER_SIGN, T1.CREATEDATE, THAOTAC, T1.TT   INTO	  #TmpHeThong 
FROM 
(
	SELECT	T1.MS_HE_THONG, T1.TEN_HE_THONG, T1.GHI_CHU, T1.NO_LINE, T1.MA_HE_THONG,
		USER_SIGN,  CREATEDATE,  
		CASE T1.THAO_TAC WHEN 1 THEN @Them WHEN 2 THEN @Sua WHEN 3 THEN @Xoa END AS THAOTAC  , T1.THAO_TAC AS TT  
		
	FROM dbo.W_HE_THONG T1
	WHERE CONVERT(DATE,CREATEDATE) BETWEEN @TNgay AND @DNgay
	UNION	
	
	SELECT T1.MS_HE_THONG, T1.TEN_HE_THONG, T1.GHI_CHU, T1.NO_LINE, T1.MA_HE_THONG,
	NULL USER_SIGN, NULL AS CREATEDATE, NULL THAOTAC , CONVERT(INT,0) AS TT 
	FROM dbo.HE_THONG T1
	WHERE T1.MS_HE_THONG IN(SELECT MS_HE_THONG FROM dbo.W_HE_THONG WHERE CONVERT(DATE,CREATEDATE) BETWEEN @TNgay AND @DNgay)
	
) T1
	ORDER BY  MS_HE_THONG,TT DESC, CREATEDATE DESC	

	SELECT * FROM #TmpHeThong T1
	ORDER BY  (SELECT MAX(T2.CREATEDATE) FROM #TmpHeThong T2 WHERE T1.MS_HE_THONG = T2.MS_HE_THONG) DESC, ISNULL(CREATEDATE,GETDATE()) DESC	
END
END





END
GO

/****** Object:  StoredProcedure [dbo].[spGetListMay]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS OFF
GO

SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[spGetListMay]
 @UserName Nvarchar(50),
 @MsNXuong Nvarchar(50),
 @NHeThong int,
 @MsLoaiMay nvarchar(20),
  @MsNhomMay nvarchar(20),
  @NNGU int
AS
BEGIN

SELECT MS_MAY,TEN_MAY FROM dbo.MGetMayUserNgay(GETDATE(),@UserName,@MsNXuong,@NHeThong,-1,@MsLoaiMay,@MsNhomMay, '-1',@NNGU) ORDER BY TEN_MAY


END
GO

/****** Object:  StoredProcedure [dbo].[spGetListMayNguyenNhan]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetListMayNguyenNhan]
@bLoai BIT = 1,
@MS_MAY NVARCHAR(30) = 'BANG-BEL-002',
 @UserName Nvarchar(50) = 'admin',
  @NNGU INT = 0
AS
BEGIN
IF @bLoai = 0
BEGIN
SELECT B.MS_NGUYEN_NHAN,C.CauseCode,C.TEN_NGUYEN_NHAN,B.DVT,B.DINH_MUC FROM dbo.MAY A
INNER JOIN dbo.MAY_NGUYEN_NHAN B ON B.MS_MAY = A.MS_MAY
INNER JOIN dbo.NGUYEN_NHAN_DUNG_MAY C ON C.MS_NGUYEN_NHAN = B.MS_NGUYEN_NHAN
WHERE A.MS_MAY = @MS_MAY AND C.Planned = 1
END
ELSE
BEGIN
SELECT C.MS_NGUYEN_NHAN,C.CauseCode,C.TEN_NGUYEN_NHAN,ISNULL(B.DVT,2) AS DVT,B.DINH_MUC FROM dbo.MAY A
LEFT JOIN dbo.MAY_NGUYEN_NHAN B ON B.MS_MAY = A.MS_MAY AND A.MS_MAY = @MS_MAY
RIGHT JOIN dbo.NGUYEN_NHAN_DUNG_MAY C ON C.MS_NGUYEN_NHAN = B.MS_NGUYEN_NHAN
WHERE C.Planned = 1
END
END
GO

/****** Object:  StoredProcedure [dbo].[GetDON_VI_TINH_GIO]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE proc [dbo].[GetDON_VI_TINH_GIO]
@NNgu INT = 0 
AS
SELECT MS_DVT_GIO,CASE @NNgu WHEN 0 THEN TEN_DVT_GO WHEN 1 THEN ISNULL(NULLIF(TEN_DVT_GO_A,''),TEN_DVT_GO) ELSE ISNULL(NULLIF(TEN_DVT_GO_H,''),TEN_DVT_GO) END AS TEN_DVT_GO
 FROM dbo.DON_VI_TINH_GIO
 ORDER BY MS_DVT_GIO
GO

/****** Object:  StoredProcedure [dbo].[spSaveDevicesCause]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[spSaveDevicesCause]
    @MS_MAY nvarchar(30),
	@sBT  nvarchar(200)
AS
    BEGIN
        CREATE TABLE #DevicesCauseTMP
            (
				[MS_NGUYEN_NHAN] [int] NULL,
				[CauseCode] [nvarchar] (max),
				[TEN_NGUYEN_NHAN] [nvarchar] (250)  NULL,
				[DVT] INT NULL,
				[DINH_MUC] [int] NULL
            )
        ON  [PRIMARY]
        DECLARE @sSql NVARCHAR(4000)
        SET @sSql = 'INSERT INTO #DevicesCauseTMP ( MS_NGUYEN_NHAN, CauseCode, TEN_NGUYEN_NHAN,
                                    DVT, DINH_MUC ) SELECT MS_NGUYEN_NHAN, CauseCode, TEN_NGUYEN_NHAN, DVT, DINH_MUC FROM ' + @sBT 
        EXEC (@sSql)
		SET @sSql = ' DROP TABLE '+@sBT
        EXEC (@sSql)
		DELETE	dbo.MAY_NGUYEN_NHAN WHERE MS_MAY = @MS_MAY
		INSERT INTO dbo.MAY_NGUYEN_NHAN ( MS_MAY, MS_NGUYEN_NHAN, DVT, DINH_MUC )
		SELECT @MS_MAY,MS_NGUYEN_NHAN,  DVT, DINH_MUC FROM #DevicesCauseTMP

    END







GO

/****** Object:  StoredProcedure [dbo].[spNguyenNhanNgungMayByProDetails]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spNguyenNhanNgungMayByProDetails]
	@MS_MAY NVARCHAR(30) ='-1',
	@TuNgay DATETIME ='2020-03-04 00:00:00.000',
	@DenNgay DATETIME ='2022-03-04 00:00:00.000',
	@NNgu INT =0
AS 
BEGIN
SELECT  A.MS_LAN,A.CaID,CASE @NNgu WHEN 0 THEN G.ItemName WHEN 1 THEN ISNULL(NULLIF (G.ItemNameA, ''), G.ItemName) 
							 ELSE ISNULL(NULLIF (G.ItemNameH, ''), G.ItemName) END  AS ItemName  ,A.MS_NGUYEN_NHAN, D.NGAY,C.CA,
        CONVERT(DATETIME, CONVERT(NVARCHAR(20), A.NGAY, 23) + ' '
        + CONVERT(NVARCHAR(20), A.TU_GIO, 24)) AS TU_NGAY,
        CONVERT(DATETIME, CONVERT(NVARCHAR(20), A.DEN_NGAY, 23) + ' '
        + CONVERT(NVARCHAR(20), A.DEN_GIO, 24)) AS DEN_NGAY, A.THOI_GIAN_SUA,A.THOI_GIAN_SUA_CHUA,
        B.TEN_NGUYEN_NHAN,A.ProductionRunDetailsID,B.Planned
FROM    dbo.THOI_GIAN_NGUNG_MAY A
INNER JOIN dbo.NGUYEN_NHAN_DUNG_MAY B ON B.MS_NGUYEN_NHAN = A.MS_NGUYEN_NHAN 
INNER JOIN dbo.CA C ON A.CaID = C.STT 
INNER JOIN dbo.THOI_GIAN_NGUNG_MAY_SO_LAN D ON D.MS_LAN = A.MS_LAN
INNER JOIN dbo.ProductionRunDetails E ON E.DetailID = A.ProductionRunDetailsID
INNER JOIN dbo.Item G ON G.ID = E.ItemID
WHERE A.MS_MAY = @MS_MAY AND D.NGAY BETWEEN @TuNgay AND @DenNgay
ORDER BY TU_NGAY DESC
END



GO

/****** Object:  StoredProcedure [dbo].[spSaveThoiGianNgungMay]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spSaveThoiGianNgungMay]
	@bSoLan BIT ,
    @flag BIT ,
    @ProDetailsID BIGINT ,
    @CaID INT ,
    @MsHT INT ,
    @MS_MAY NVARCHAR(30) ,
    @MS_LAN NVARCHAR(50) ,
    @TU_NGAY DATETIME ,
    @TU_GIO DATETIME ,
    @DEN_NGAY DATETIME ,
    @DEN_GIO DATETIME ,
    @MS_NGUYEN_NHAN INT ,
    @TG_SUA FLOAT ,
    @TG_SUA_CHUA FLOAT,
	@TG_KHOA DATETIME
AS
    BEGIN
        IF @flag = 1
            BEGIN
---insert dữ liệu số lần
				IF @bSoLan = 1

				BEGIN
                INSERT  INTO dbo.THOI_GIAN_NGUNG_MAY_SO_LAN ( MS_LAN, MS_MAY,
                                                              NGAY, TU_GIO,
                                                              NGUOI_GIAI_QUYET,
                                                              NGUYEN_NHAN,
                                                              HIEN_TUONG,
                                                              NGUYEN_NHAN_CU_THE,
                                                              NGAY_KT, GIO_KT,
                                                              NGAY_SX, CaID,
                                                              MS_NGUYEN_NHAN,
                                                              TRUONG_CA,
                                                              MS_PHIEU_BAO_TRI,
                                                              LOCK, KHONG_DC,
                                                              MS_TO )
                VALUES  ( @MS_LAN, -- MS_LAN - varchar(50)
                          @MS_MAY, -- MS_MAY - nvarchar(30)
                          @TU_NGAY, -- NGAY - datetime
                          @TU_GIO, -- TU_GIO - datetime
                          N'', -- NGUOI_GIAI_QUYET - nvarchar(250)
                          ( SELECT  TEN_NGUYEN_NHAN
                            FROM    dbo.NGUYEN_NHAN_DUNG_MAY
                            WHERE   MS_NGUYEN_NHAN = @MS_NGUYEN_NHAN
                          ), -- NGUYEN_NHAN - nvarchar(250)
                          N'', -- HIEN_TUONG - nvarchar(250)
                          N'', -- NGUYEN_NHAN_CU_THE - nvarchar(255)
                          @DEN_NGAY, -- NGAY_KT - datetime
                          @DEN_GIO, -- GIO_KT - datetime
                          GETDATE(), -- NGAY_SX - datetime
                          @CaID, -- CaID - int
                          @MS_NGUYEN_NHAN, -- MS_NGUYEN_NHAN - int
                          N'', -- TRUONG_CA - nvarchar(250)
                          N'', -- MS_PHIEU_BAO_TRI - nvarchar(20)
                          NULL, -- LOCK - bit
                          NULL, -- KHONG_DC - bit
                          0  -- MS_TO - int
                          ) 
				END
---insert dữ liệu thời gian ngừng mấy
                INSERT  INTO dbo.THOI_GIAN_NGUNG_MAY ( MS_MAY, NGAY, TU_GIO,
                                                       DEN_NGAY, DEN_GIO,
                                                       MS_NGUYEN_NHAN, GHI_CHU,
                                                       TRUONG_CA,
                                                       NGUOI_GIAI_QUYET, DUNG,
                                                       MS_HE_THONG,
                                                       THOI_GIAN_SUA_CHUA,
                                                       MS_N_XUONG, MS_LAN,
                                                       THOI_GIAN_SUA,
                                                       NGUYEN_NHAN,
                                                       NGUYEN_NHAN_CU_THE,
                                                       HIEN_TUONG, CaID,
                                                       ProductionRunID,
                                                       ProductionRunDetailsID )
                VALUES  ( @MS_MAY, -- MS_MAY - nvarchar(30)
                          @TU_NGAY, -- NGAY - datetime
                          @TU_GIO, -- TU_GIO - datetime
                          @DEN_NGAY, -- DEN_NGAY - datetime
                          @DEN_GIO, -- DEN_GIO - datetime
                          @MS_NGUYEN_NHAN, -- MS_NGUYEN_NHAN - int
                          N'', -- GHI_CHU - nvarchar(500)
                          N'', -- TRUONG_CA - nvarchar(250)
                          N'', -- NGUOI_GIAI_QUYET - nvarchar(250)
                          NULL, -- DUNG - bit
                          @MsHT, -- MS_HE_THONG - int
                          @TG_SUA, -- THOI_GIAN_SUA_CHUA - float
                          ( SELECT  MS_N_XUONG
                            FROM    dbo.MAY_NHA_XUONG
                            WHERE   MS_MAY = @MS_MAY
                          ), -- MS_N_XUONG - nvarchar(50)
                          @MS_LAN, -- MS_LAN - varchar(50)
                          @TG_SUA, -- THOI_GIAN_SUA - float
                          ( SELECT  TEN_NGUYEN_NHAN
                            FROM    dbo.NGUYEN_NHAN_DUNG_MAY
                            WHERE   MS_NGUYEN_NHAN = @MS_NGUYEN_NHAN
                          ), -- NGUYEN_NHAN - nvarchar(250)
                          N'', -- NGUYEN_NHAN_CU_THE - nvarchar(255)
                          N'', -- HIEN_TUONG - nvarchar(250)
                          @CaID, -- CaID - int
                          0, -- ProductionRunID - bigint
                          @ProDetailsID  -- ProductionRunDetailsID - bigint
                          )
            END
        ELSE
            BEGIN
					--update dữ liệu
					UPDATE dbo.THOI_GIAN_NGUNG_MAY
					SET NGAY =@DEN_NGAY,
					TU_GIO = @TU_GIO,
					DEN_NGAY = @DEN_NGAY,
					DEN_GIO = @DEN_GIO,
					THOI_GIAN_SUA =@TG_SUA,
					THOI_GIAN_SUA_CHUA = @TG_SUA_CHUA,
					MS_HE_THONG =@MsHT,
					MS_NGUYEN_NHAN =@MS_NGUYEN_NHAN,
					NGUYEN_NHAN = ( SELECT  TEN_NGUYEN_NHAN
                            FROM    dbo.NGUYEN_NHAN_DUNG_MAY
                            WHERE   MS_NGUYEN_NHAN = @MS_NGUYEN_NHAN
                          )
					WHERE MS_LAN = @MS_LAN AND MS_MAY =@MS_MAY AND CONVERT(DATETIME, CONVERT(NVARCHAR(20), NGAY, 23) + ' '
        + CONVERT(NVARCHAR(20), TU_GIO, 24)) = @TG_KHOA
					--update dữ liệu
					--UPDATE dbo.THOI_GIAN_NGUNG_MAY_SO_LAN
					--SET NGAY =@DEN_NGAY,
					--TU_GIO = @TU_GIO,
					--NGAY_KT = @DEN_NGAY,
					--GIO_KT =@TG_SUA,
					--MS_NGUYEN_NHAN =@MS_NGUYEN_NHAN,
					--NGUYEN_NHAN = ( SELECT  TEN_NGUYEN_NHAN
     --                       FROM    dbo.NGUYEN_NHAN_DUNG_MAY
     --                       WHERE   MS_NGUYEN_NHAN = @MS_NGUYEN_NHAN
     --                     ),
					--CaID = @CaID
					--WHERE MS_LAN = @MS_MAY
            END	
    END
GO

/****** Object:  StoredProcedure [dbo].[spGetCaTuNgayDenNgay]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetCaTuNgayDenNgay]
 @TN DATETIME = '1900-01-02 01:00:01.000',
 @DN DATETIME = '1900-01-02 01:30:00.000',
 @ID_CA INT =2
AS	
BEGIN
SELECT STT, TU_GIO, DEN_GIO INTO #TMPCA FROM dbo.CA WHERE STT = @ID_CA
UPDATE #TMPCA SET DEN_GIO = DATEADD(DAY,1,DEN_GIO) WHERE CONVERT(TIME,TU_GIO) > CONVERT(TIME,DEN_GIO)

SELECT * FROM #TMPCA

SELECT TOP 1 STT,TU_GIO,DEN_GIO FROM #TMPCA WHERE @TN BETWEEN TU_GIO AND DEN_GIO AND @DN BETWEEN TU_GIO AND DEN_GIO
END

GO

/****** Object:  StoredProcedure [dbo].[spKiemTraGioHopLe]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


	CREATE PROCEDURE [dbo].[spKiemTraGioHopLe]
		@TuNgay DATETIME = '2021-03-03 17:00:00.000',
		@DenNgay DATETIME = '2021-03-03 18:21:48.487',
		@MS_MAY NVARCHAR(30) = 'CHIE-VOL-001',
		@ScheduleID BIGINT = '81',
		@sBTam NVARCHAR(200) ='TMPKTTGAdmin'
	AS 
	BEGIN
	--- kiểm tra 3 trường hợp
	--1 từ ngày không nằm trong dữ liệu
	--2 đến ngày không nằm trong dữ liệu
	--3 dữ liệu hông nằm trong từ đến
	CREATE TABLE #BTTG (
	[ScheduleID] BIGINT NULL,
	[MS_MAY] NVARCHAR(30) NULL,
	[PlannedStartTime] DATETIME NULL,
	[DueTime] DATETIME NULL
) 

DECLARE @sSql nvarchar(4000)
set @sSql = 'INSERT INTO #BTTG ( ScheduleID, MS_MAY, PlannedStartTime, DueTime )  SELECT DISTINCT [ScheduleID],[MS_MAY],[PlannedStartTime],[DueTime] FROM ' + @sBTam
EXEC (@sSql)



	SELECT DISTINCT ScheduleID,MS_MAY,PlannedStartTime,DueTime into #TMP FROM dbo.ProSchedule WHERE MS_MAY = @MS_MAY AND ScheduleID != @ScheduleID
	UNION
	 SELECT ScheduleID,MS_MAY,PlannedStartTime,DueTime FROM #BTTG
	 WHERE MS_MAY = @MS_MAY AND ScheduleID != @ScheduleID
	
	SELECT COUNT(*) FROM #TMP 
	WHERE (@TuNgay BETWEEN PlannedStartTime AND DueTime) OR (@DenNgay BETWEEN PlannedStartTime AND DueTime) OR (PlannedStartTime BETWEEN @TuNgay AND @DenNgay)
	END


GO

/****** Object:  StoredProcedure [dbo].[spKiemTraNgayTrung]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spKiemTraNgayTrung]
 @TN DATETIME = '2020-01-01 23:00:00.000',
 @DN DATETIME = '2021-01-01 23:30:00.000',
 @MS_MAY NVARCHAR(30) = 'CHIE-MES-004'
AS	
BEGIN
SELECT NGAY + TU_GIO AS NGAYBD ,DEN_NGAY+DEN_GIO AS NGAYKT INTO #TMP FROM dbo.THOI_GIAN_NGUNG_MAY WHERE MS_MAY = @MS_MAY
SELECT COUNT(*) FROM #TMP WHERE (@TN BETWEEN NGAYBD AND NGAYKT) OR (@DN BETWEEN NGAYBD AND NGAYKT) OR (NGAYBD BETWEEN @TN AND @DN)
END
GO

/****** Object:  StoredProcedure [dbo].[spDeleteThoiGianNgungMay]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spDeleteThoiGianNgungMay]
    @MS_LAN NVARCHAR(50),
	@TU_NGAY DATETIME
AS
BEGIN
    DELETE FROM dbo.THOI_GIAN_NGUNG_MAY
	WHERE CONVERT(DATETIME, CONVERT(NVARCHAR(20), NGAY, 23) + ' '
        + CONVERT(NVARCHAR(20), TU_GIO, 24)) = @TU_NGAY AND MS_LAN = @MS_LAN
		-- kiểm tra nếu còn lần nào nữa thì không xóa thời gian ngừng mấy số lần
		IF (SELECT COUNT(*) FROM dbo.THOI_GIAN_NGUNG_MAY WHERE MS_LAN = @MS_LAN) = 0 
		BEGIN
			DELETE dbo.THOI_GIAN_NGUNG_MAY_SO_LAN WHERE MS_LAN =@MS_LAN
		END
END
GO

/****** Object:  StoredProcedure [dbo].[spGetCongNhan]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetCongNhan]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@CoAll BIT=1
AS 
BEGIN
IF @CoAll = 1
BEGIN
SELECT * FROM(
SELECT MS_CONG_NHAN,(HO + ' ' +TEN) AS TEN_CONG_NHAN  FROM dbo.CONG_NHAN
UNION 
SELECT -1,'< All >')T
ORDER BY T.TEN_CONG_NHAN;
END
ELSE
BEGIN
SELECT MS_CONG_NHAN,(HO + ' ' +TEN) AS TEN_CONG_NHAN  FROM dbo.CONG_NHAN
ORDER BY TEN_CONG_NHAN
END	
END	


GO

/****** Object:  StoredProcedure [dbo].[spGetBaoCaoChiTiet]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetBaoCaoChiTiet]
	@ID_TO BIGINT = -1,
	@MS_MAY NVARCHAR(30) ='-1',
	@TU_NGAY DATETIME = '2020-03-02 14:00:00.000',
	@DEN_NGAY DATETIME = '2022-03-02 14:00:00.000',
	@USERNAME NVARCHAR(250) ='admin',
	@NNgu INT = 0,
	@bLoaiBC BIT = 1
AS
    BEGIN
	--@bLoaiBC = 0 BÁO CÁO GỘP
	--@bLoaiBC = 1 BÁO Chi tiết
	--CONVERT(NUMERIC(18,2), ( B.TH / B.NPH ) * 100) AS PE,
	--CONVERT(NUMERIC(18,2),( B.TH / B.GPH ) * 100) AS OEE,
	--CONVERT(NUMERIC(18,2),( B.DT / B.GPH ) * 100) AS DTP,
	DECLARE @BaseOUMName  NVARCHAR(50) = (SELECT TOP 1 UOMName  FROM dbo.UOM WHERE BasedUOM =1)
	SELECT A.* INTO #MAY FROM dbo.MGetMayUserNgay(GETDATE(),@username,'-1',-1,-1,'-1','-1','-1', @NNgu) A
	 IF @bLoaiBC = 0
	BEGIN
	SELECT C.TEN_MAY + '('+  B.MS_MAY + ')' AS TEN_MAY,E.ItemName,SUM(B.ActualQuantity) AS ActualQuantity,@BaseOUMName AS BaseOUMName,
	CONVERT(NUMERIC(18,2),SUM(B.GPH)) AS GPH,
	CONVERT(NUMERIC(18,2),SUM(B.TH)) AS TH,
	CONVERT(NUMERIC(18,2),SUM(B.DT)) AS DT,
	CONVERT(NUMERIC(18,2),SUM(B.EL)) AS EL,
	CONVERT(NUMERIC(18,2),SUM(B.NPH)) AS NPH, 
	CONVERT(NUMERIC(18,2),(SUM(B.TH) /SUM(B.NPH)) * 100) AS PE,
	CONVERT(NUMERIC(18,2),(SUM( B.TH) / SUM(B.GPH )) * 100) AS OEE,
	CONVERT(NUMERIC(18,2),(SUM(B.DT) /SUM(B.GPH)) * 100) AS DTP,
	CONVERT(NUMERIC(18,2),(SUM(B.EL) /SUM(B.NPH)) * 100) AS ELP,
	CONVERT(NUMERIC(18,2),CONVERT(NUMERIC(18,2),SUM(B.EL) - ( SUM(NPH) - SUM(B.TH) ))) AS ELV 
	FROM dbo.MGetApiOEE(-1,@ID_TO,@MS_MAY,@TU_NGAY,@DEN_NGAY,@USERNAME, @NNgu) B
	INNER JOIN #MAY C ON C.MS_MAY = B.MS_MAY
	INNER JOIN dbo.Operator D ON B.OperatorID = D.ID	
	INNER JOIN dbo.Item E ON E.ID = B.ItemID
	GROUP BY  C.TEN_MAY,B.MS_MAY,E.ItemName
	END
	ELSE
	BEGIN
	SELECT D.OperatorName,C.TEN_MAY + '('+  B.MS_MAY + ')' AS TEN_MAY,B.StartTime,B.StandardOutput,[dbo].[fnGetDVTCongSuat](B.ItemID) AS CapacityUOM,B.ItemID,E.ItemName,SUM(B.ActualQuantity) AS ActualQuantity,@BaseOUMName AS BaseOUMName,
	CONVERT(NUMERIC(18,2),SUM(B.GPH)) AS GPH,
	CONVERT(NUMERIC(18,2),SUM(B.TH)) AS TH,
	CONVERT(NUMERIC(18,2),SUM(B.DT)) AS DT,
	CONVERT(NUMERIC(18,2),SUM(B.EL)) AS EL,
	CONVERT(NUMERIC(18,2),SUM(B.NPH)) AS NPH, 
	CONVERT(NUMERIC(18,2),(SUM(B.TH) /SUM(B.NPH)) * 100) AS PE,
	CONVERT(NUMERIC(18,2),(SUM( B.TH) / SUM(B.GPH )) * 100) AS OEE,
	CONVERT(NUMERIC(18,2),(SUM(B.DT) /SUM(B.GPH)) * 100) AS DTP,
	CONVERT(NUMERIC(18,2),(SUM(B.EL) /SUM(B.NPH)) * 100) AS ELP,
	CONVERT(NUMERIC(18,2),CONVERT(NUMERIC(18,2),SUM(B.EL) - ( SUM(NPH) - SUM(B.TH) ))) AS ELV 
	FROM dbo.MGetApiOEE(-1,@ID_TO,@MS_MAY,@TU_NGAY,@DEN_NGAY,@USERNAME, @NNgu) B
	INNER JOIN #MAY C ON C.MS_MAY = B.MS_MAY
	INNER JOIN dbo.Operator D ON B.OperatorID = D.ID	
	INNER JOIN dbo.Item E ON E.ID = B.ItemID
	GROUP BY  D.OperatorName,C.TEN_MAY,B.MS_MAY,B.StartTime,B.StandardOutput,B.ItemID,E.ItemName
	END
	END	

	
GO

/****** Object:  StoredProcedure [dbo].[spGetPlaned]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetPlaned]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@CoAll BIT=1
AS 
BEGIN
IF @CoAll = 1
BEGIN
SELECT * FROM (SELECT ID, CASE @NNgu WHEN 0 THEN StopTypeName WHEN 1 THEN ISNULL(StopTypeNameA,StopTypeName) WHEN 2 THEN ISNULL(StopTypeNameH,StopTypeName) END AS StopTypeName  FROM dbo.StopType
UNION
SELECT -1,N'< ALL >') A
ORDER BY A.ID
END
ELSE
BEGIN
SELECT ID, CASE @NNgu WHEN 0 THEN StopTypeName WHEN 1 THEN ISNULL(StopTypeNameA,StopTypeName) WHEN 2 THEN ISNULL(StopTypeNameH,StopTypeName) END AS StopTypeName  FROM dbo.StopType
ORDER BY ID
END	
END	


GO

/****** Object:  StoredProcedure [dbo].[spKiemTraGioHopLeRun]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


--SELECT * FROM TMPPRORUNadmin
	CREATE PROCEDURE [dbo].[spKiemTraGioHopLeRun]
		@MS_MAY NVARCHAR(30) = 'CHIE-MES-001',
		@DetailID BIGINT = '71',
		@PrOID BIGINT = '71',
		@TuNgay DATETIME = '2021-03-09 06:00:00.000',
		@DenNgay DATETIME = '2021-03-09 08:00:00.000',
		@sBTam NVARCHAR(200) ='TMPPRORUNadmin'
	AS 
	BEGIN
	--- kiểm tra 3 trường hợp
	--1 từ ngày không nằm trong dữ liệu
	--2 đến ngày không nằm trong dữ liệu
	--3 dữ liệu hông nằm trong từ đến
	CREATE TABLE #BTTG (
	[DetailID] BIGINT NULL,
	[ItemID] BIGINT NULL,
	[MS_MAY] NVARCHAR(30) NULL,
	[StartTime] DATETIME NULL,
	[EndTime] DATETIME NULL
) 

DECLARE @sSql nvarchar(4000)
set @sSql = 'INSERT INTO #BTTG ( DetailID,ItemID, MS_MAY, StartTime, EndTime )  SELECT DISTINCT [DetailID],[ItemID],[MS_MAY],[StartTime],[EndTime] FROM ' + @sBTam
EXEC (@sSql)

	SELECT  DetailID, MS_MAY,ItemID, StartTime, EndTime into #TMP FROM dbo.ProductionRunDetails WHERE MS_MAY = @MS_MAY AND PrOID != @PrOID
	UNION
	 SELECT DetailID, MS_MAY,ItemID, StartTime, EndTime FROM #BTTG
	 WHERE MS_MAY = @MS_MAY  /*AND DetailID != @DetailID*/
	
	SELECT COUNT(*) FROM #TMP 
	WHERE ( @TuNgay >  StartTime AND @TuNgay < EndTime) OR (@DenNgay > StartTime AND @DenNgay < EndTime) OR (StartTime > @TuNgay AND StartTime < @DenNgay) OR @TuNgay =StartTime
	END

GO

/****** Object:  StoredProcedure [dbo].[spGetBaoCaoTongHopHieuXuat]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetBaoCaoTongHopHieuXuat]
	@MS_N_XUONG NVARCHAR(50) = '-1',
	@MS_LOAI_MAY NVARCHAR(30) ='-1',
	@TU_NGAY DATETIME = '2021-03-02 14:00:00.000',
	@DEN_NGAY DATETIME = '2022-03-02 14:00:00.000',
	@USERNAME NVARCHAR(250) ='admin',
	@NNgu INT = 0
AS
    BEGIN

	SELECT A.* INTO #MAY FROM dbo.MGetMayUserNgay(GETDATE(),@username,@MS_N_XUONG,-1,-1,@MS_LOAI_MAY,'-1','-1', @NNgu) A
	
	SELECT C.TEN_MAY,
	CONVERT(NUMERIC(18,2),SUM(B.TH)) AS TH,
	CONVERT(NUMERIC(18,2),SUM(B.GPH)) AS GPH,
	CONVERT(NUMERIC(18,2),SUM(B.NPH)) AS NPH, 
	CONVERT(NUMERIC(18,2),SUM(B.EL)) AS EL,
	CONVERT(NUMERIC(18,2),CONVERT(NUMERIC(18,2),SUM(B.EL) - ( SUM(NPH) - SUM(B.TH) ))) AS ELV ,
	CONVERT(NUMERIC(18,2),(SUM( B.TH) / SUM(B.GPH )) * 100) AS OEE,
	CONVERT(NUMERIC(18,2),(SUM(B.TH) /SUM(B.NPH)) * 100) AS PE,
	CONVERT(NUMERIC(18,2),(SUM(B.EL) /SUM(B.NPH)) * 100) AS ELP,
	CONVERT(NUMERIC(18,2),(SUM(B.ELV) /SUM(B.TH)) * 100) AS ELVP,
	D.OEE AS DMOEE,
	D.PE AS DMPE,
	D.EL AS DMEL,
	D.SpeedVar
	FROM dbo.MGetApiOEE(-1,-1,'-1',@TU_NGAY,@DEN_NGAY,@USERNAME, @NNgu) B
	INNER JOIN #MAY C ON C.MS_MAY = B.MS_MAY
	LEFT JOIN dbo.Target D ON D.MS_MAY = B.MS_MAY and D.Year = DATEPART(YEAR,@TU_NGAY) 
	GROUP BY  C.TEN_MAY,D.OEE,D.PE,D.SpeedVar,D.EL
	ORDER BY C.TEN_MAY
	
	END	
GO

/****** Object:  StoredProcedure [dbo].[spGetListTarget]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[spGetListTarget]
	@FLAG BIT = 1,	
	@NAM INT =2022,
	@USERNAME NVARCHAR(250) ='admin',
	@NNgu INT = 0
AS 
BEGIN
	SELECT A.* INTO #MAY FROM dbo.MGetMayUserNgay(GETDATE(),@username,'-1',-1,-1,'-1','-1','-1', @NNgu) A

--@FLAG BIT = 0, load dữ liệu trên lưới
--@FLAG BIT = 1, tự động tính từ OEE
IF @FLAG = 0
BEGIN

IF(SELECT COUNT(*) FROM dbo.TargetOfYear WHERE [Year] = @NAM ) = 1
BEGIN
SELECT  T.MS_MAY,T.TEN_MAY,OEE,PE,EL,SpeedVar FROM (
SELECT #MAY.MS_MAY,TEN_MAY,OEE,PE,EL,SpeedVar ,0 AS STT FROM dbo.Target INNER JOIN #MAY ON #MAY.MS_MAY = Target.MS_MAY WHERE [Year] = @NAM 
UNION 
SELECT '',N'TỔNG SX',OEE,PE,EL,SpeedVar,1 AS STT FROM dbo.TargetOfYear WHERE [Year] = @NAM) AS T ORDER BY T.STT,T.TEN_MAY
END
ELSE
BEGIN
SELECT T.MS_MAY,T.TEN_MAY,OEE,PE,EL,SpeedVar FROM (
SELECT #MAY.MS_MAY,TEN_MAY,OEE,PE,EL,SpeedVar ,0 AS STT FROM dbo.Target INNER JOIN #MAY ON #MAY.MS_MAY = Target.MS_MAY WHERE [Year] = @NAM 
UNION 
	SELECT '',N'TỔNG SX', CONVERT(DECIMAL(18,2),NULL) AS OEE, CONVERT(DECIMAL(18,2),NULL) AS	PE, CONVERT(DECIMAL(18,2),NULL) AS	ELP, CONVERT(DECIMAL(18,2),NULL) AS	ELVP ,1 AS	STT)  AS T ORDER BY T.STT,T.TEN_MAY
END

END
ELSE
BEGIN
	--Lấy giá trị của năm trước  
	--kiểm tra dữ liệu năm trước có không nếu có thì lấy còn không thì lấy từ productionder
	IF(SELECT COUNT(*)
	FROM dbo.MGetApiOEE(-1,-1,'-1',CONVERT(DATETIME,'01/01/'+ CAST(@NAM AS NVARCHAR(4))),CONVERT(DATETIME,'12/31/'+CAST(@NAM  AS NVARCHAR(4))),@USERNAME, @NNgu) B) = 0
	BEGIN
	  SELECT T.MS_MAY,TEN_MAY,OEE,PE,T.EL,T.SpeedVar FROM ( 
		SELECT A.MS_MAY,B.TEN_MAY,A.OEE,A.PE,A.EL,A.SpeedVar,0 AS STT  FROM dbo.Target A INNER JOIN #MAY B ON B.MS_MAY = A.MS_MAY WHERE [Year] = @NAM 
		UNION
	  SELECT DISTINCT ProductionRunDetails.MS_MAY,TEN_MAY, CONVERT(DECIMAL(18,2),NULL) AS	OEE, CONVERT(DECIMAL(18,2),NULL) AS	PE, CONVERT(DECIMAL(18,2),NULL) AS	EL, CONVERT(DECIMAL(18,2),NULL) AS	SpeedVar ,0 AS STT 
	  FROM dbo.ProductionRunDetails 
	  INNER JOIN #MAY ON #MAY.MS_MAY = ProductionRunDetails.MS_MAY
	  WHERE NOT EXISTS (SELECT * FROM dbo.Target B WHERE #MAY.MS_MAY = B.MS_MAY AND [Year] = @NAM)
	UNION 
	SELECT  '',N'TỔNG SX', CONVERT(DECIMAL(18,2),NULL) AS	OEE, CONVERT(DECIMAL(18,2),NULL) AS	PE, CONVERT(DECIMAL(18,2),NULL) AS	EL, CONVERT(DECIMAL(18,2),NULL) AS	SpeedVar ,1 AS	STT)  AS T ORDER BY T.STT,T.TEN_MAY
	
	END
	ELSE
    BEGIN
	SELECT B.MS_MAY,C.TEN_MAY,
	CONVERT(NUMERIC(18,2),(SUM( B.TH) / SUM(B.GPH )) * 100) AS OEE,
	CONVERT(NUMERIC(18,2),(SUM(B.TH) /SUM(B.NPH)) * 100) AS PE,
	CONVERT(NUMERIC(18,2),(SUM(B.EL) /SUM(B.NPH)) * 100) AS ELP,
	CONVERT(NUMERIC(18,2),(SUM(B.ELV) /SUM(B.TH)) * 100) AS ELVP INTO #TMP
	FROM dbo.MGetApiOEE(-1,-1,'-1',CONVERT(DATETIME,'01/01/'+ CAST(@NAM AS NVARCHAR(4))),CONVERT(DATETIME,'12/31/'+CAST(@NAM  AS NVARCHAR(4))),@USERNAME, @NNgu) B
	INNER JOIN #MAY C ON C.MS_MAY = B.MS_MAY GROUP BY B.MS_MAY,C.TEN_MAY
	
	SELECT T.MS_MAY,TEN_MAY,OEE,PE,EL, SpeedVar FROM (
	SELECT MS_MAY,TEN_MAY,OEE,PE,ELP AS EL,ELVP AS SpeedVar,0 AS STT FROM  #TMP 
	UNION	
	SELECT '',N'TỔNG SX',
           CONVERT(NUMERIC(18,2),AVG(OEE)) AS OEE,
           CONVERT(NUMERIC(18,2),AVG(PE)) AS PE,
           CONVERT(NUMERIC(18,2),AVG(ELP)) AS ELP,
           CONVERT(NUMERIC(18,2),AVG(ELVP)) AS ELVP,1 FROM #TMP ) AS T ORDER BY T.STT,T.TEN_MAY
	END
END
END	





--SELECT B.MS_MAY,C.TEN_MAY,
--	CONVERT(NUMERIC(18,2),(SUM( B.TH) / SUM(B.GPH )) * 100) AS OEE,
--	CONVERT(NUMERIC(18,2),(SUM(B.TH) /SUM(B.NPH)) * 100) AS PE,
--	CONVERT(NUMERIC(18,2),(SUM(B.EL) /SUM(B.NPH)) * 100) AS ELP,
--	CONVERT(NUMERIC(18,2),(SUM(B.ELV) /SUM(B.TH)) * 100) AS ELVP 
--	FROM dbo.MGetApiOEE(-1,-1,'-1',CONVERT(DATETIME,'01/01/'+ CAST(@NAM AS NVARCHAR(4))),CONVERT(DATETIME,'12/31/'+CAST(@NAM  AS NVARCHAR(4))),@USERNAME, @NNgu) B
--	INNER JOIN #MAY C ON C.MS_MAY = B.MS_MAY GROUP BY B.MS_MAY,C.TEN_MAY
GO

/****** Object:  StoredProcedure [dbo].[spSaveTarget]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spSaveTarget]
    @NAM INT ='2021' ,
    @sBT NVARCHAR(100) = 'TMPProDucRunDetailsadmin'
AS
    BEGIN
        CREATE TABLE #Target
            (
            [MS_MAY] NVARCHAR(30) NULL,
			[TEN_MAY] [NVARCHAR](255) NULL,
			[OEE] DECIMAL(18,2) NULL,
			[PE] DECIMAL(18,2) NULL,
			[EL] DECIMAL(18,2) NULL,
			[SpeedVar] DECIMAL(18,2) NULL
            )
        ON  [PRIMARY]

        DECLARE @sSql NVARCHAR(4000)
        SET @sSql = 'INSERT INTO #Target(MS_MAY,TEN_MAY,OEE,PE,EL,SpeedVar) SELECT MS_MAY,TEN_MAY,OEE,PE,EL,SpeedVar FROM ' + @sBT 
        EXEC (@sSql)
		SET @sSql = 'DROP TABLE  ' + @sBT 
        EXEC (@sSql)
		    
			--xóa dữ liệu của năm hiện tại
			DELETE dbo.Target WHERE Year = @NAM
			DELETE dbo.TargetOfYear WHERE Year = @NAM

			--INSERT
			INSERT INTO dbo.Target(Year,MS_MAY,OEE,PE,EL,SpeedVar)		SELECT @NAM,MS_MAY,OEE,PE,EL,SpeedVar FROM #Target WHERE ISNULL(MS_MAY,'') != ''
			INSERT INTO dbo.TargetOfYear(Year,OEE,PE,EL,SpeedVar) SELECT @NAM,OEE,PE,EL,SpeedVar FROM #Target WHERE ISNULL(MS_MAY,'') = ''
		END	







GO

/****** Object:  StoredProcedure [dbo].[spGetLoaiNguyenNhan]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetLoaiNguyenNhan]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0,
	@CoAll BIT=1
AS 
BEGIN
IF @CoAll = 1
BEGIN
SELECT ID, CASE @NNgu WHEN 0 THEN DownTimeTypeName WHEN 1 THEN ISNULL(NULLIF(DownTimeTypeNameA,''),DownTimeTypeName) ELSE ISNULL(NULLIF(DownTimeTypeNameH,''),DownTimeTypeName) END AS DownTimeTypeName FROM dbo.DownTimeType
UNION SELECT -1 AS ID,'< All >'AS DownTimeTypeName
ORDER BY DownTimeTypeName  
END
ELSE
BEGIN
SELECT ID, CASE @NNgu WHEN 0 THEN DownTimeTypeName WHEN 1 THEN ISNULL(NULLIF(DownTimeTypeNameA,''),DownTimeTypeName) ELSE ISNULL(NULLIF(DownTimeTypeNameH,''),DownTimeTypeName) END AS DownTimeTypeName FROM dbo.DownTimeType
ORDER BY DownTimeTypeName

END	
END	


GO

/****** Object:  StoredProcedure [dbo].[spGetKeHoach]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetKeHoach]
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =1
AS 
BEGIN

SELECT -1 AS ID,'< All >'AS KeHoach
UNION
 SELECT 1, CASE @NNgu WHEN 0 THEN N'Có kế hoạch'ELSE 'Plan' END	
 UNION
  SELECT 0,CASE @NNgu WHEN 0 THEN N'Không có kế hoạch' ELSE 'Not Plan' END	
  
END	


GO

/****** Object:  StoredProcedure [dbo].[spGetListChosseMayPro]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[spGetListChosseMayPro]
	@MS_N_XUONG NVARCHAR(50) = '-1',
	@MS_LOAI_MAY NVARCHAR(20) ='-1',
	@Username NVARCHAR(100) ='admin',
	@NNgu INT =0
AS 
BEGIN
SELECT DISTINCT CONVERT(BIT,1)AS CHON, A.MS_MAY,A.TEN_MAY  FROM dbo.MGetMayUserNgay(GETDATE(),@Username,@MS_N_XUONG,-1,-1,@MS_LOAI_MAY,'-1','-1', @NNgu)	A
INNER JOIN dbo.ProductionRunDetails B ON B.MS_MAY = A.MS_MAY
ORDER BY  A.MS_MAY
END	



GO

/****** Object:  StoredProcedure [dbo].[spGetListChosseNguyenNhanPro]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[spGetListChosseNguyenNhanPro]
    @DownTimeTypeID INT = '-1',
    @Planned INT = '-1',
    @Username NVARCHAR(100) = 'admin',
    @NNgu INT = 0
AS
BEGIN
    SELECT CONVERT(BIT, 1) AS CHON,A.MS_NGUYEN_NHAN,A.DownTimeTypeID,
           CauseCode,
           CASE @NNgu
               WHEN 0 THEN
                   TEN_NGUYEN_NHAN
               WHEN 1 THEN
                   ISNULL(NULLIF(TEN_NGUYEN_NHAN_ANH, ''), TEN_NGUYEN_NHAN)
           END AS TEN_NGUYEN_NHAN,
           
           CASE @NNgu
               WHEN 0 THEN
                   B.StopTypeName
               WHEN 1 THEN
                   ISNULL(NULLIF(B.StopTypeNameA, ''), StopTypeName) ELSE ISNULL(NULLIF(B.StopTypeNameH, ''), StopTypeName)
           END AS StopTypeName
    FROM dbo.NGUYEN_NHAN_DUNG_MAY A
	INNER JOIN  dbo.StopType B ON B.ID = A.Planned
	WHERE (DownTimeTypeID = @DownTimeTypeID OR @DownTimeTypeID = -1) AND (Planned = @Planned OR @Planned = -1)
END;



GO

/****** Object:  StoredProcedure [dbo].[spGetListPareto]    Script Date: 29/03/2021 10:09:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[spGetListPareto]
    @TuNgay DATETIME ='2020-03-25 15:11:41.117',
    @DenNgay DATETIME ='2021-03-25 15:11:41.117',
	@SbtMay NVARCHAR(200) ='sBTMayadmin',
	@SbtNN NVARCHAR(200) = 'sBTNguyenNhanadmin',
    @Username NVARCHAR(100) = 'admin',
    @NNgu INT = 0
AS
BEGIN

CREATE TABLE #TEMPT_MAY (
[MS_MAY] [NVARCHAR] (30) ,
[TEN_MAY] [NVARCHAR] (250)
) ON [PRIMARY]


DECLARE @sSql NVARCHAR(4000)
SET @sSql = 'INSERT INTO #TEMPT_MAY(MS_MAY,TEN_MAY) SELECT [MS_MAY],[TEN_MAY] FROM ' + @SbtMay
EXEC (@sSql)
SET @sSql = 'DROP TABLE ' + @SbtMay
EXEC (@sSql)


CREATE TABLE #TEMPT_NN (
MS_NGUYEN_NHAN INT,
DownTimeTypeID INT,
[CauseCode] [NVARCHAR] (50) NULL,
[TEN_NGUYEN_NHAN] [NVARCHAR] (250)NULL,
) ON [PRIMARY]

SET @sSql = 'INSERT INTO #TEMPT_NN (MS_NGUYEN_NHAN,DownTimeTypeID,CauseCode,TEN_NGUYEN_NHAN) SELECT [MS_NGUYEN_NHAN],[DownTimeTypeID],[CauseCode],[TEN_NGUYEN_NHAN] FROM ' + @SbtNN
EXEC (@sSql)
set @sSql = 'DROP TABLE ' + @SbtNN
EXEC (@sSql)

SELECT A.MS_MAY,C.TEN_MAY,E.DownTimeTypeName,D.CauseCode,D.TEN_NGUYEN_NHAN,SUM(A.THOI_GIAN_SUA_CHUA) AS TONG_SO_PHUT ,COUNT(THOI_GIAN_SUA_CHUA) AS SO_LAN_XAY_RA,CONVERT(DECIMAL(18,2),AVG(A.THOI_GIAN_SUA_CHUA)) AS SO_PHUT_TB INTO #TMP
FROM dbo.THOI_GIAN_NGUNG_MAY A
INNER JOIN  #TEMPT_MAY C ON C.MS_MAY = A.MS_MAY
INNER JOIN  #TEMPT_NN D ON D.MS_NGUYEN_NHAN = A.MS_NGUYEN_NHAN
INNER JOIN  dbo.DownTimeType E ON E.ID = D.DownTimeTypeID
WHERE A.NGAY BETWEEN @TuNgay AND @DenNgay
GROUP BY A.MS_MAY,C.TEN_MAY,E.DownTimeTypeName,D.CauseCode,D.TEN_NGUYEN_NHAN
-- tổng số thời gian ngừng máy theo máy
SELECT MS_MAY + '('+ TEN_MAY+')' AS TEN_MAY,
       DownTimeTypeName,
       CauseCode,
       TEN_NGUYEN_NHAN,
       TONG_SO_PHUT,
	   CONVERT(DECIMAL(18,2),(TONG_SO_PHUT / (SELECT SUM(TONG_SO_PHUT) FROM #TMP WHERE #TMP.MS_MAY = A.MS_MAY))*100) AS PT_NGUNG_MAY,
       SO_LAN_XAY_RA,
	   SO_PHUT_TB
	   FROM #TMP A
	   ORDER BY A.MS_MAY,A.TEN_MAY,A.DownTimeTypeName,A.TEN_NGUYEN_NHAN


END


GO


